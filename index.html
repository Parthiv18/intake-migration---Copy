<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Intake Pipeline</title>
    <link
      rel="icon"
      href="https://cdn.brandfetch.io/idQbNDKa7o/theme/dark/symbol.svg?c=1bx1742335544623id64Mup7acmj3isyyG&t=1683555048490"
    />
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"
    ></script>
    <script defer src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #fff;
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
        width: 100vw;
        overflow-x: hidden;
      }
      html,
      #main,
      #jrm-content,
      #total-content,
      .container,
      #non-ofs-container,
      #ofs-wrapper,
      .cards-container,
      .row,
      .col {
        background: #fff !important;
        min-height: 100vh;
        box-sizing: border-box;
      }
      html {
        width: 100vw;
        overflow-x: hidden;
      }
      #loadingBarContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: #ddd;
        z-index: 2000;
      }
      #loadingBar {
        width: 0;
        height: 100%;
        background: #4a90e2;
        transition: width 0.2s ease;
      }
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        background: #333;
        width: 180px;
        height: 100%;
        padding: 20px;
        overflow-y: auto;
        z-index: 1000;
      }
      #sidebar button {
        display: block;
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        background: #444;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
      }
      #sidebar button:hover {
        background: #555;
      }
      #uploadContainer {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 140px;
      }
      #uploadContainer button {
        margin-top: 5px;
      }
      #changeCounter {
        color: #fff;
        margin-top: 5px;
        font-size: 0.9em;
        text-align: center;
        cursor: pointer;
        text-decoration: underline;
      }
      #loginContainer {
        position: fixed;
        bottom: 20px;
        left: 10px;
        width: 160px;
        padding: 8px;
        background: #d4d3d3;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        z-index: 1500;
        font-size: 0.9em;
      }
      #loginContainer input,
      #loginContainer button {
        width: 100%;
        padding: 4px;
        font-size: 0.9em;
      }
      .requires-login {
        display: none;
      }
      #main {
        margin-left: 160px;
        padding: 0;
        min-height: 100vh;
        width: calc(100vw - 180px);
        box-sizing: border-box;
      }
      @media screen and (max-width: 768px) {
        #sidebar {
          position: relative;
          width: 100%;
          height: auto;
        }
        #main {
          margin-left: 0;
          width: 100vw;
        }
      }
      .hidden {
        display: none;
      }
      .container {
        background: #fff;
        padding: 20px;
        border-radius: 0;
        box-shadow: none;
        margin-bottom: 0;
        min-height: 100vh;
        width: 100%;
        box-sizing: border-box;
      }
      .summary {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
      }
      .summary > div {
        flex: 1;
        min-width: 150px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
      }
      .filters-container {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }
      .filter-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      #checkboxes label {
        margin-right: 15px;
        font-weight: normal;
      }
      .table-wrapper,
      #metrics-table-container {
        overflow-x: auto;
      }
      .jrm-card {
        background: #f7f7f7;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(44, 62, 80, 0.08);
        padding: 24px 20px 36px;
        margin-bottom: 22px;
        position: relative;
        transition: transform 0.22s, box-shadow 0.22s;
        border: 1.5px solid #e5e9f2;
      }
      .jrm-card:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow: 0 6px 24px rgba(44, 62, 80, 0.13);
        border-color: #4f8cff;
      }
      .jrm-card h3 {
        margin: 0 0 10px;
        font-size: 1.35em;
        color: #23272f;
        font-weight: 700;
        letter-spacing: 0.01em;
      }
      .jrm-card h3 a {
        color: #23272f;
        text-decoration: none;
        overflow-wrap: break-word;
        transition: color 0.2s;
      }
      .jrm-card h3 a:hover {
        color: #4f8cff;
        text-decoration: underline;
      }
      .jrm-card p {
        font-size: 1em;
        color: #4f5b6b;
        margin: 8px 0;
      }
      .jrm-card .attachment {
        position: absolute;
        bottom: 12px;
        left: 14px;
      }
      .jrm-card .attachment a {
        font-size: 0.97em;
        color: #4f8cff;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
      }
      .jrm-card .attachment a:hover {
        color: #38c6d9;
        text-decoration: underline;
      }
      .row {
        display: flex;
        gap: 20px;
        margin: 0;
        min-height: 100vh;
        width: 100%;
        box-sizing: border-box;
      }
      .col {
        flex: 1;
        position: relative;
        padding-left: 6px;
        min-height: 100vh;
        width: 100%;
        box-sizing: border-box;
      }
      .col h2 {
        position: sticky;
        top: 0;
        background: #fff;
        padding: 10px;
        margin: 0;
        border-bottom: 2px solid #ccc;
        z-index: 2;
      }
      .cards-container {
        max-height: 85vh;
        overflow-y: auto;
        padding-right: 10px;
        min-height: 100vh;
        width: 100%;
        box-sizing: border-box;
      }
      #intake-charts {
        margin-top: 20px;
      }
      #intake-charts .data,
      #intake-charts #chart-header {
        margin-left: 48px !important;
      }
      #intake-charts .data > div:first-child {
        margin-left: 10px;
      }
      .charts-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin: 20px 0;
      }
      table.modern-table {
        width: 100%;
        min-width: 200px;
        border-collapse: separate;
        border-spacing: 0;
        background: #fdfdfd;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(44, 62, 80, 0.07);
        font-size: 1.1em;
        margin-bottom: 0;
      }
      table.modern-table th {
        background: #009879;
        color: #fff;
        font-weight: 600;
        white-space: nowrap;
        border: none;
        padding: 6px 8px;
        font-size: 0.95em;
        text-align: left;
        letter-spacing: 0.02em;
      }
      table.modern-table th:first-child {
        border-top-left-radius: 12px;
      }
      table.modern-table th:last-child {
        border-top-right-radius: 12px;
      }
      table.modern-table td {
        background: #f7fafb;
        color: #23272f;
        border: none;
        border-bottom: 1.5px solid #e5e9f2;
        padding: 5px 8px;
        font-size: 0.95em;
        transition: background 0.18s;
      }
      table.modern-table tr:last-child td {
        border-bottom: none;
      }
      table.modern-table tr:nth-child(even) td {
        background: #f2f6f8;
      }
      table.modern-table tr:hover td {
        background: #eaf6f3;
        color: #009879;
        transition: background 0.18s, color 0.18s;
      }
      table.modern-table th,
      table.modern-table td {
        white-space: nowrap;
        vertical-align: middle;
        border-right: 1.5px solid #e5e9f2;
      }
      table.modern-table th:last-child,
      table.modern-table td:last-child {
        border-right: none;
      }
      th.dropdown-header .dropdown-arrow {
        font-size: 0.8em;
        margin-left: 4px;
      }
      a.intake-link {
        color: #23272f;
        text-decoration: underline;
        cursor: pointer;
        font-weight: 500;
        transition: color 0.18s;
      }
      a.intake-link:hover {
        color: #38c6d9;
      }
      #addIntakeFormContainer,
      #addMetricFormContainer {
        border-top: 1px solid #ddd;
        margin-top: 20px;
        padding-top: 20px;
        display: none;
      }
      #addIntakeFormContainer input,
      #addIntakeFormContainer textarea,
      #addMetricFormContainer input,
      #addMetricFormContainer textarea {
        display: block;
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
      }
      #addIntakeFormContainer label,
      #addMetricFormContainer label {
        margin-bottom: 5px;
        font-weight: bold;
      }
      .custom-context-menu {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 3000;
        padding: 5px 0;
        border-radius: 4px;
      }
      .custom-context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .custom-context-menu li {
        padding: 8px 15px;
        cursor: pointer;
      }
      .custom-context-menu li:hover {
        background: #f0f0f0;
      }
      #jrm-content,
      #total-content {
        padding-left: 32px;
        padding-right: 8px;
        background: none !important;
        min-height: 100vh;
      }
      #changeLogModal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        padding: 24px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
        border-radius: 8px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 3000;
      }
      #changeLogModal h3 {
        margin: 0;
      }
      #changeLogModal button {
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="loadingBarContainer"><div id="loadingBar"></div></div>
    <div id="sidebar">
      <button id="jrmBtn">JRM</button>
      <button id="totalBtn">ESTIMATES</button>
      <button id="dashboardBtn">STATS</button>
      <button id="definitionBtn">DEFINITIONS</button>
      <div id="uploadContainer" class="requires-login">
        <button id="saveFileBtn">Save</button>
        <div id="changeCounter">0 change(s) made</div>
      </div>
    </div>
    <div id="main">
      <div id="dashboard-content" class="hidden"></div>
      <div id="total-content" class="hidden"></div>
      <div id="jrm-content" class="hidden"></div>
      <div id="intake-charts" class="hidden"></div>
    </div>
    <div id="changeLogModal">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h3>Change Log</h3>
        <button id="closeChangeLogBtn">&times;</button>
      </div>
      <div id="changeLogContent" style="margin-top: 16px"></div>
    </div>
    <div id="loginContainer">
      <div><strong>User:</strong> CPT</div>
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Login</button>
    </div>
    <!-- Export Modal (add this block) -->
    <div
      id="exportModal"
      style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
        z-index: 4000;
        padding: 24px;
        min-width: 260px;
      "
    >
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h3 style="margin: 0">Export Options</h3>
        <button
          id="closeExportModalBtn"
          style="
            font-size: 1.2em;
            background: none;
            border: none;
            cursor: pointer;
          "
        >
          &times;
        </button>
      </div>
      <div
        style="
          margin-top: 18px;
          display: flex;
          flex-direction: column;
          gap: 12px;
        "
      >
        <button id="exportExcelBtn" style="padding: 10px; font-size: 1em">
          Export as Excel
        </button>
        <button id="exportPdfBtn" style="padding: 10px; font-size: 1em">
          Export as PDF
        </button>
      </div>
    </div>
    <script defer>
      (() => {
        const $ = (id) => document.getElementById(id);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const addListener = (sel, evt, fn) =>
          $$(sel).forEach((el) => el.addEventListener(evt, fn));
        const fmtCur = (num) =>
          new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
          }).format(num);
        const parseCur = (val) =>
          typeof val === "string"
            ? parseFloat(val.replace(/[^0-9.-]+/g, "")) || 0
            : Number(val) || 0;

        const parseDMY = (str) => {
          if (!str) return new Date("Invalid Date");
          if (str.includes("/")) {
            const parts = str.split("/");
            return new Date(parts[2], parts[1] - 1, parts[0]);
          } else {
            const parts = str.split(" ");
            if (parts.length !== 2) {
              return new Date(str);
            }
            const [monthDay, year] = parts;
            const [monthStr, day] = monthDay.split("-");
            const months = {
              Jan: 0,
              Feb: 1,
              Mar: 2,
              Apr: 3,
              May: 4,
              Jun: 5,
              Jul: 6,
              Aug: 7,
              Sept: 8,
              Oct: 9,
              Nov: 10,
              Dec: 11,
            };
            const month = months[monthStr] !== undefined ? months[monthStr] : 0;
            return new Date(year, month, day);
          }
        };

        const inRange = (dmy, s, e) => {
          const d = parseDMY(dmy);
          const sDate = s ? new Date(s) : null;
          const eDate = e ? new Date(e) : null;
          return (
            (!sDate || d >= sDate) &&
            (!eDate || d <= eDate.setDate(eDate.getDate() + 1))
          );
        };
        const normalizeID = (id) =>
          String(id || "")
            .trim()
            .toUpperCase()
            .replace(/^ENT-/, "");
        const createOption = (val, text) =>
          Object.assign(document.createElement("option"), {
            value: val,
            textContent: text,
          });

        const formatUIDate = (dateValue) => {
          if (!dateValue) return "N/A";
          let date;
          if (dateValue instanceof Date) {
            date = dateValue;
          } else {
            date = new Date(dateValue);
          }
          if (isNaN(date)) return dateValue;
          const months = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sept",
            "Oct",
            "Nov",
            "Dec",
          ];
          return (
            months[date.getMonth()] +
            "-" +
            date.getDate() +
            " " +
            date.getFullYear()
          );
        };

        const formatExcelDate = (dateVal) => {
          if (!dateVal) return "N/A";
          const d = new Date(dateVal);
          if (isNaN(d)) return dateVal;
          return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
        };

        let isLoggedIn = false;
        let changeCount = 0;
        const changeLog = [];
        const updateChangeCounterDisplay = () => {
          $("changeCounter").textContent = changeCount + " change(s) made";
        };

        $("changeCounter").onclick = function () {
          if (changeCount === 0) {
            $("changeLogContent").innerHTML =
              "<em>No changes made in this session.</em>";
          } else {
            $("changeLogContent").innerHTML = changeLog
              .map(
                (entry, i) =>
                  `<div style="margin-bottom:10px;">
                <span style="font-weight:bold;">${i + 1}.</span> ${entry}
              </div>`
              )
              .join("");
          }
          $("changeLogModal").style.display = "block";
        };
        $("closeChangeLogBtn").onclick = function () {
          $("changeLogModal").style.display = "none";
        };
        window.addEventListener("keydown", function (e) {
          if (e.key === "Escape") $("changeLogModal").style.display = "none";
        });

        function logChange(msg) {
          changeLog.push(msg);
        }

        const state = {
          jrmHeader: null,
          jrmDateMapping: {},
          jrmApprovedMapping: {},
          jrmNameMapping: {},
          jrmCommentsMapping: {},
          jrmTagsMapping: {},
          jrmRows: [],
          metricsRows: [],
          tableHeaders: [],
          metricOptions: [],
          metricMapping: {},
          metricsIDs: new Set(),
          rawMetrics: [],
        };
        const OTHER = ["ba", "qa", "aoto", "pmo", "dev"];
        const checkboxLabels = {
          ba: "BA",
          qa: "QA",
          aoto: "AO/TO",
          pmo: "PMO",
          dev: "Dev",
        };
        const dp = {
          et: "et",
          ba: "et-ba",
          qa: "et-qa",
          aoto: "ao/to",
          pmo: "pmo",
          dev: "et-dev",
        };

        let loadingInterval;
        const startLoadingBar = () => {
          const loadingBar = $("loadingBar");
          let progress = 0;
          loadingBar.style.width = "0%";
          loadingInterval = setInterval(() => {
            if (progress < 90)
              progress = Math.min(90, progress + Math.random() * 5);
            loadingBar.style.width = progress + "%";
          }, 100);
        };
        const completeLoadingBar = () => {
          clearInterval(loadingInterval);
          $("loadingBar").style.width = "100%";
          setTimeout(() => {
            $("loadingBarContainer").style.display = "none";
          }, 500);
        };

        const fetchLatestFileURL = async () => {
          const maxVersion = 500;
          const basePath = "./Database/Intake_Database_";
          const fallback = "./Database/Intake_Database.xlsx";

          const exists = async (v) => {
            const url = `${basePath}${v}.xlsx`;
            try {
              const resp = await fetch(url, { method: "HEAD" });
              return resp.ok ? url : null;
            } catch {
              return null;
            }
          };

          let low = 1;
          let high = maxVersion;
          let bestURL = null;
          while (low <= high) {
            const mid = Math.floor((low + high) / 2);
            const url = await exists(mid);
            if (url) {
              bestURL = url;
              low = mid + 1;
            } else {
              high = mid - 1;
            }
          }

          return bestURL || fallback;
        };

        async function fetchData() {
          startLoadingBar(); // if you want the progress bar
          try {
            const response = await fetch("/data");
            if (!response.ok) throw new Error("Network response was not ok");
            const { jrm, metrics } = await response.json();

            // jrm is an array of objects; convert to sheet-like arrays:
            const jrmCols = Object.keys(jrm[0] || {});
            const jrmValues = jrm.map((row) => jrmCols.map((c) => row[c]));
            processJRM([jrmCols, ...jrmValues]);

            const metricsCols = Object.keys(metrics[0] || {});
            const metricsValues = metrics.map((row) =>
              metricsCols.map((c) => row[c])
            );
            processMetrics([metricsCols, ...metricsValues]);

            completeLoadingBar();
          } catch (e) {
            console.error("Error fetching data:", e);
            completeLoadingBar();
          }
        }

        const processMetrics = (sheet) => {
          const raw = sheet; // Already an array of arrays
          state.rawMetrics = raw;
          if (!raw || raw.length < 2)
            return console.error("Metrics sheet has no data.");
          const incl = [];
          raw[0].forEach((hdr, col) => {
            if (hdr !== "Intake Name") {
              incl.push(col);
              let headerText =
                hdr.trim().toLowerCase() === "lob sub-total"
                  ? "CPT-LOB Sub-Total"
                  : hdr;
              if (!["Intake Name", "Intake ID"].includes(headerText)) {
                headerText = headerText
                  .replace(/TC/g, "Total Cost")
                  .replace(/E%/g, "Effort %")
                  .replace(/C%/g, "Cost %");
              }
              state.tableHeaders.push(headerText);
            }
          });
          state.metricsRows = raw
            .slice(1)
            .map((row) =>
              incl.map((idx) =>
                row[idx] instanceof Date
                  ? row[idx].toLocaleDateString("en-US")
                  : row[idx] || ""
              )
            );
          state.metricsIDs = new Set(
            state.metricsRows.map((r) => normalizeID(r[0]))
          );
          state.tableHeaders.splice(1, 0, "Intake Name");
          state.metricsRows.forEach((row) =>
            row.splice(1, 0, state.jrmNameMapping[normalizeID(row[0])] || "")
          );
          state.tableHeaders.forEach((hdr, i) => {
            if (!["Intake ID", "Intake Name"].includes(hdr)) {
              state.metricOptions.push(hdr);
              state.metricMapping[hdr] = i;
            }
          });
          setupTotalContent();
          generateIntakeCards(state.rawMetrics);
          initCharts(state.rawMetrics);
          OTHER.forEach((d) =>
            $(d + "Checkbox").addEventListener("change", updateMetricSelect)
          );
          ["startDateTotal", "endDateTotal"].forEach((id) =>
            $(id).addEventListener("change", () => {
              updateChartAndTable($("metric").value);
              updateDisciplineTables();
            })
          );
          $("clearTotal").addEventListener("click", () => {
            OTHER.forEach((d) => {
              const checkbox = $(d + "Checkbox");
              if (checkbox) {
                checkbox.checked = false;
              }
            });
            ["startDateTotal", "endDateTotal"].forEach(
              (id) => ($(id).value = "")
            );

            const quickDate = $("quickDateDropdown");
            if (quickDate) quickDate.value = "";
            updateMetricSelect();
          });
          updateMetricSelect();
        };

        const processJRM = (sheet) => {
          const raw = sheet; // Already an array of arrays
          if (!raw || raw.length < 2)
            return console.error("JRM sheet has no data.");
          state.jrmHeader = raw[0];
          state.jrmRows = raw.slice(1);
          state.jrmApprovedMapping = {};
          state.jrmCommentsMapping = {};
          state.jrmTagsMapping = {};
          const cards = { jrm: [], estimates: [], approved: [], ofs: [] };
          let html = `<div class="container">
              <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
                <input type="text" id="searchInput" placeholder="Search by Intake ID, Name or Tags">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
                <!-- Quick Date Dropdown for JRM -->
                <select id="quickDateDropdownJRM" style="min-width:110px;">
                  <option value="">Quick Date</option>
                  <option value="week">Past 1 Week</option>
                  <option value="month">Past 1 Month</option>
                  <option value="4months">Past 4 Months</option>
                  <option value="year">Past Year</option>
                </select>
                <select id="statusDropdown">
                  <option value="all">Show All</option>
                  <option value="closed">Closed</option>
                  <option value="ofs">Out of Scope</option>
                </select>
                <button id="addIntakeBtn" class="requires-login">Add</button>
                <button id="clearButton">Clear</button>
                <span id="counter">Intakes Count: 0</span>
              </div>
              <div id="addIntakeFormContainer">
                <h3>Add New Intake</h3>
                <label for="newIntakeId">Intake ID</label>
                <input type="text" id="newIntakeId" placeholder="e.g., ENT-17063">
                <label for="newIntakeName">Intake Name</label>
                <input type="text" id="newIntakeName" placeholder="Enter Intake Name">
                <label for="newIntakeComments">Intake Comments</label>
                <textarea id="newIntakeComments" placeholder="Enter Comments"></textarea>
                <label for="newIntakeTags">Intake Tags</label>
                <input type="text" id="newIntakeTags" placeholder="Enter Tags">
                <label for="newIntakeDate">Date</label>
                <input type="date" id="newIntakeDate">
                <button id="submitIntakeBtn">Submit</button>
              </div>`;
          raw.slice(1).forEach((row) => {
            let [
              id = "",
              name = "",
              comments = "",
              tags = "",
              rawStatus = "",
              attach = "",
              date,
              approvedDate,
            ] = row;
            const status = String(rawStatus).toLowerCase(),
              dispDate = formatUIDate(date),
              dispApproved = formatUIDate(approvedDate),
              closed = status === "approved" && String(attach).trim() !== "",
              normId = normalizeID(id);
            state.jrmNameMapping[normId] = name;
            state.jrmDateMapping[normId] = dispDate;
            state.jrmApprovedMapping[normId] = dispApproved;
            state.jrmCommentsMapping[normId] = comments;
            state.jrmTagsMapping[normId] = tags;
            const viewLink =
              status === "approved"
                ? `<div style="position:absolute;bottom:10px;right:10px;"><a href="javascript:void(0)" data-intake-id="${normId}" class="view-link">View</a></div>`
                : "";
            const card = `<div class="jrm-card" data-intake-id="${id}" data-intake-name="${name}" data-intake-tags="${tags}" data-intake-date="${dispDate}" data-status="${status}" data-closed="${closed}">
                          <h3><a href="https://jira.cibcatl.com/browse/ENT-${normId}" target="_blank">ENT-${normId} - ${name}</a></h3>
                          <p><strong>Date:</strong> ${dispDate}</p>
                          <p><strong>Approved Date:</strong> ${dispApproved}</p>
                          <p><strong>Comments:</strong> ${comments}</p>
                          <p><strong>Tags:</strong> ${tags}</p>
                          ${
                            String(attach).trim()
                              ? `<div class="attachment"><a href="${attach}" target="_blank">PDF</a></div>`
                              : ""
                          }
                          ${viewLink}
                        </div>`;
            cards[status] ? cards[status].push(card) : null;
          });
          html += `<div id="non-ofs-container" class="cards-container">
                     <div class="row">
                       <div class="col" id="jrm-col"><h2>JRM</h2>${cards.jrm.join(
                         ""
                       )}</div>
                       <div class="col" id="estimates-col"><h2>Estimates</h2>${cards.estimates.join(
                         ""
                       )}</div>
                       <div class="col" id="approved-col"><h2>Approved</h2>${cards.approved.join(
                         ""
                       )}</div>
                     </div>
                   </div>
                   <div id="ofs-wrapper" style="display:none;">
                     <h2>Out of Scope</h2>
                     <div id="ofs-container">${cards.ofs.join("")}</div>
                   </div>
                 </div>`;
          $("jrm-content").innerHTML = html;
          addListener(
            "#searchInput, #startDate, #endDate, #statusDropdown",
            "input",
            filterCards
          );
          $("clearButton").addEventListener("click", () => {
            ["searchInput", "startDate", "endDate"].forEach(
              (id) => ($(id).value = "")
            );
            $("statusDropdown").value = "all";

            const quickDateJRM = $("quickDateDropdownJRM");
            if (quickDateJRM) quickDateJRM.value = "";
            filterCards();
          });
          $("addIntakeBtn").addEventListener("click", toggleAddIntakeForm);
          $("submitIntakeBtn").addEventListener("click", submitIntakeForm);
          $("jrm-content").addEventListener("click", (e) => {
            if (e.target.classList.contains("view-link"))
              showData(e.target.getAttribute("data-intake-id"));
          });

          const quickDateJRM = $("quickDateDropdownJRM");
          const startDateJRM = $("startDate");
          const endDateJRM = $("endDate");
          quickDateJRM.addEventListener("change", () => {
            const today = new Date();
            let start = "",
              end = "";
            if (quickDateJRM.value === "week") {
              const d = new Date(today);
              d.setDate(d.getDate() - 7);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else if (quickDateJRM.value === "month") {
              const d = new Date(today);
              d.setMonth(d.getMonth() - 1);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else if (quickDateJRM.value === "4months") {
              const d = new Date(today);
              d.setMonth(d.getMonth() - 4);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else if (quickDateJRM.value === "year") {
              const d = new Date(today);
              d.setFullYear(d.getFullYear() - 1);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else {
              start = "";
              end = "";
            }
            startDateJRM.value = start;
            endDateJRM.value = end;
            filterCards();
          });

          startDateJRM.addEventListener("input", () => {
            if (quickDateJRM.value) quickDateJRM.value = "";
          });
          endDateJRM.addEventListener("input", () => {
            if (quickDateJRM.value) quickDateJRM.value = "";
          });
          filterCards();
          initCardContextMenu();
        };

        const initCardContextMenu = () => {
          $("jrm-content").addEventListener("contextmenu", (e) => {
            if (!isLoggedIn) return;
            const card = e.target.closest(".jrm-card");
            if (!card) return;
            e.preventDefault();
            removeContextMenu();
            const currentStatus = card.getAttribute("data-status"),
              statuses = ["jrm", "estimates", "approved", "ofs"],
              options = statuses.filter((s) => s !== currentStatus),
              menu = Object.assign(document.createElement("div"), {
                className: "custom-context-menu",
                style: `top:${e.pageY}px; left:${e.pageX}px;`,
              }),
              ul = document.createElement("ul");

            const liEdit = document.createElement("li");
            liEdit.textContent = "Edit";
            liEdit.addEventListener("click", () => {
              removeContextMenu();
              enterEditMode(card);
            });
            ul.appendChild(liEdit);

            options.forEach((opt) => {
              const li = document.createElement("li");
              li.textContent =
                "Move to " +
                (opt === "ofs"
                  ? "Out of Scope (ofs)"
                  : opt.charAt(0).toUpperCase() + opt.slice(1));
              li.addEventListener("click", () => {
                card.setAttribute("data-status", opt);
                const cardId = normalizeID(card.getAttribute("data-intake-id"));
                state.jrmRows = state.jrmRows.map((row) => {
                  if (normalizeID(row[0]) === cardId) row[4] = opt;
                  return row;
                });
                if (opt === "jrm") $("jrm-col").appendChild(card);
                else if (opt === "estimates")
                  $("estimates-col").appendChild(card);
                else if (opt === "approved")
                  $("approved-col").appendChild(card);
                else if (opt === "ofs") $("ofs-container").appendChild(card);
                changeCount++;
                logChange(
                  `Moved Intake <b>ENT-${cardId}</b> to <b>${opt.toUpperCase()}</b>`
                );
                fetch(`/jrm/ENT-${cardId}/status`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ status: opt }),
                })
                  .then((r) => r.json())
                  .then(console.log);
                updateChangeCounterDisplay();
                removeContextMenu();
              });
              ul.appendChild(li);
            });
            const liAddAttachment = document.createElement("li");
            liAddAttachment.textContent = "Add Attachment";
            liAddAttachment.addEventListener("click", () => {
              removeContextMenu();
              const link = prompt("Enter attachment link:");
              if (link && link.trim() !== "") {
                const cardId = normalizeID(card.getAttribute("data-intake-id"));
                state.jrmRows = state.jrmRows.map((row) => {
                  if (normalizeID(row[0]) === cardId) {
                    row[5] = link;
                  }
                  return row;
                });
                let attachmentDiv = card.querySelector(".attachment");
                if (attachmentDiv) {
                  const a = attachmentDiv.querySelector("a");
                  a.href = link;
                } else {
                  const newDiv = document.createElement("div");
                  newDiv.className = "attachment";
                  newDiv.style.position = "absolute";
                  newDiv.style.bottom = "10px";
                  newDiv.style.left = "10px";
                  newDiv.innerHTML = `<a href="${link}" target="_blank">PDF</a>`;
                  card.appendChild(newDiv);
                }
                changeCount++;
                logChange(
                  `Added/Updated attachment for Intake <b>ENT-${cardId}</b>`
                );
                fetch(`/jrm/ENT-${cardId}/attachment`, {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    attachment: link,
                  }),
                }).then((response) => {
                  if (!response.ok)
                    throw new Error(
                      `Attachment update failed: ${response.statusText}`
                    );
                  return response.json();
                });
                updateChangeCounterDisplay();
              }
            });
            ul.appendChild(liAddAttachment);
            const liDelete = document.createElement("li");
            liDelete.textContent = "Delete";
            liDelete.style.color = "red";
            liDelete.addEventListener("click", () => {
              const cardId = normalizeID(card.getAttribute("data-intake-id"));
              state.jrmRows = state.jrmRows.filter(
                (row) => normalizeID(row[0]) !== cardId
              );
              delete state.jrmNameMapping[cardId];
              delete state.jrmDateMapping[cardId];
              delete state.jrmApprovedMapping[cardId];
              delete state.jrmCommentsMapping[cardId];
              delete state.jrmTagsMapping[cardId];
              card.parentNode.removeChild(card);
              changeCount++;
              logChange(`Deleted Intake <b>ENT-${cardId}</b>`);
              fetch(`/jrm/ENT-${cardId}`, {
                method: "DELETE",
              })
                .then((response) => {
                  if (!response.ok)
                    throw new Error(`Delete failed: ${response.statusText}`);
                  return response.json();
                })
                .then((data) => {
                  console.log("Delete successful:", data);
                })
                .catch((error) => {
                  console.error("Error deleting intake:", error);
                });
              updateChangeCounterDisplay();
              removeContextMenu();
            });
            ul.appendChild(liDelete);
            menu.appendChild(ul);
            document.body.appendChild(menu);
          });
          document.addEventListener("click", removeContextMenu);
        };

        const removeContextMenu = () => {
          $$(".custom-context-menu").forEach((menu) =>
            menu.parentNode.removeChild(menu)
          );
        };

        const enterEditMode = (card) => {
          const cardId = normalizeID(card.getAttribute("data-intake-id"));
          const currentStatus = card.getAttribute("data-status");
          const attachEl = card.querySelector(".attachment a"),
            currentAttachment = attachEl ? attachEl.getAttribute("href") : ""; // empty string if none yet
          const currentName = state.jrmNameMapping[cardId] || "";
          const currentDateDisp = state.jrmDateMapping[cardId] || "";
          const currentApproved = state.jrmApprovedMapping[cardId] || "";
          const currentComments = state.jrmCommentsMapping[cardId] || "";
          const currentTags = state.jrmTagsMapping[cardId] || "";

          const toISO = (disp) => {
            const d = new Date(disp);
            return isNaN(d) ? "" : d.toISOString().split("T")[0];
          };
          const isoDate = toISO(currentDateDisp);
          const isoApproved = toISO(currentApproved);

          card.innerHTML = `

            <div>
              <label>Name: <input type="text" id="edit-name-${cardId}" value="${currentName}"></label>
            </div>
            <div>
              <label>Date: <input type="date" id="edit-date-${cardId}" value="${isoDate}"></label>
            </div>
            <div>
              <label>Approved Date: <input type="date" id="edit-approved-${cardId}" value="${isoApproved}"></label>
            </div>
            <div>
              <label>Comments: <textarea id="edit-comments-${cardId}">${currentComments}</textarea></label>
            </div>
            <div>
              <label>Tags: <input type="text" id="edit-tags-${cardId}" value="${currentTags}"></label>
            </div>
            <div style="margin-top:10px;">
              <button id="save-edit-${cardId}">Save</button>
              <button id="cancel-edit-${cardId}">Cancel</button>
            </div>
          `;

          $("save-edit-" + cardId).addEventListener("click", () => {
            const newName = $("edit-name-" + cardId).value.trim();
            const newDateISO = $("edit-date-" + cardId).value;
            const newDateObj = new Date(newDateISO + "T00:00");
            const newApprovedISO = $("edit-approved-" + cardId).value;
            const newApprovedDateObj = new Date(newApprovedISO + "T00:00");
            const newComments = $("edit-comments-" + cardId).value.trim();
            const newTags = $("edit-tags-" + cardId).value.trim();

            const displayDate = newDateObj
              ? formatUIDate(new Date(newDateObj))
              : "N/A";
            const displayApproved = newApprovedDateObj
              ? formatUIDate(new Date(newApprovedDateObj))
              : "N/A";

            const excelDate = newDateObj ? formatExcelDate(newDateObj) : "N/A";
            const excelApproved = newApprovedDateObj
              ? formatExcelDate(newApprovedDateObj)
              : "N/A";

            state.jrmNameMapping[cardId] = newName;
            state.jrmDateMapping[cardId] = displayDate;
            state.jrmApprovedMapping[cardId] = displayApproved;
            state.jrmCommentsMapping[cardId] = newComments;
            state.jrmTagsMapping[cardId] = newTags;

            state.jrmRows = state.jrmRows.map((row) => {
              if (normalizeID(row[0]) === cardId) {
                row[1] = newName;
                row[2] = newComments;
                row[3] = newTags;
                row[6] = new Date(newDateObj);
                row[7] = new Date(newApprovedDateObj);
              }
              return row;
            });

            card.setAttribute("data-intake-name", newName);
            card.setAttribute("data-intake-tags", newTags);
            card.setAttribute("data-intake-date", displayDate);

            let attachmentHTML = "";
            const attachEl = card.querySelector(".attachment");
            if (attachEl) {
              attachmentHTML = attachEl.outerHTML;
            }
            const newHTML = `
              <h3><a href="https://jira.cibcatl.com/browse/ENT-${cardId}" target="_blank">ENT-${cardId} - ${newName}</a></h3>
              <p><strong>Date:</strong> ${displayDate}</p>
              <p><strong>Approved Date:</strong> ${displayApproved}</p>
              <p><strong>Comments:</strong> ${newComments}</p>
              <p><strong>Tags:</strong> ${newTags}</p>
              ${attachmentHTML}
            `;
            card.innerHTML = newHTML;
            changeCount++;
            fetch(`/jrm/ENT-${cardId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                intakeName: newName,
                intakeComments: newComments,
                intakeTags: newTags,
                status: currentStatus,
                attachment: attachEl ? attachEl.href : "",
                date: displayDate,
                approvedDate: displayApproved,
              }),
            })
              .then((r) => r.json())
              .then(console.log);
            logChange(`Edited Intake <b>ENT-${cardId}</b>`);
            updateChangeCounterDisplay();
          });

          $("cancel-edit-" + cardId).addEventListener("click", () => {
            let attachmentHTML = "";
            const attachEl = card.querySelector(".attachment");
            if (attachEl) {
              attachmentHTML = attachEl.outerHTML;
            }
            const displayHTML = `
              <h3><a href="https://jira.cibcatl.com/browse/ENT-${cardId}" target="_blank">ENT-${cardId} - ${state.jrmNameMapping[cardId]}</a></h3>
              <p><strong>Date:</strong> ${state.jrmDateMapping[cardId]}</p>
              <p><strong>Approved Date:</strong> ${state.jrmApprovedMapping[cardId]}</p>
              <p><strong>Comments:</strong> ${state.jrmCommentsMapping[cardId]}</p>
              <p><strong>Tags:</strong> ${state.jrmTagsMapping[cardId]}</p>
              ${attachmentHTML}
            `;
            card.innerHTML = displayHTML;
          });
        };

        const setupTotalContent = () => {
          $("total-content").innerHTML = `
            <div class="container" style="margin-left: 12px; padding-left: 10px; padding-right: 10px;">
              <div class="summary">
                <div>Total Approved Intakes: <strong>${
                  state.metricsRows.length
                }</strong></div>
              </div>
              <div class="filters-container">
                <div class="filter-row" id="total-filters">
                  <div id="checkboxes">${OTHER.map(
                    (d) =>
                      `<label><input type="checkbox" id="${d}Checkbox"> ${
                        checkboxLabels[d] || d.toUpperCase()
                      }</label>`
                  ).join("")}</div>
                  <label for="startDateTotal">Start Date:</label>
                  <input type="date" id="startDateTotal">
                  <label for="endDateTotal">End Date:</label>
                  <input type="date" id="endDateTotal">
                  <!-- Quick Date Dropdown -->
                  <select id="quickDateDropdown" style="min-width:110px;">
                    <option value="">Quick Date</option>
                    <option value="week">Past 1 Week</option>
                    <option value="month">Past 1 Month</option>
                    <option value="4months">Past 4 Months</option>
                    <option value="year">Past Year</option>
                  </select>
                  <button id="addMetricBtn" class="requires-login">Add</button>
                  <button id="clearTotal">Clear</button>
                  <select id="metric" style="display:none"></select>
                </div>
                <div id="addMetricFormContainer">
                  <h3>Add New Metric</h3>
                  <label for="newMetricIntakeId">Intake ID</label>
                  <input type="text" id="newMetricIntakeId" placeholder="e.g., 17063 or ENT-17063">
                  <!-- Upload Excel Button -->
                  <button id="uploadMetricExcelBtn" type="button" style="margin-bottom:10px;">Upload Excel</button>
                  <input type="file" id="metricExcelFileInput" accept=".xlsx,.xlsm" style="display:none;">
                  <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${(() => {
                      const metrics = [
                        {
                          label: "Approved Date",
                          id: "newMetricApprovedDate",
                          type: "date",
                        },
                        {
                          label: "Total Ongoing Costs",
                          id: "newMetricTotalOngoingCosts",
                        },
                        { label: "LOB Sub-Total", id: "newMetricLOBSubTotal" },
                        { label: "Contingency", id: "newMetricContingency" },
                        {
                          label: "ET-BA Total Effort Days",
                          id: "newMetricETBATotalEffortDays",
                        },
                        { label: "ET-BA TC", id: "newMetricETBATC" },
                        { label: "ET-BA E%", id: "newMetricETBAE" },
                        { label: "ET-BA C%", id: "newMetricETBAC" },
                        {
                          label: "ET-Dev Total Effort Days",
                          id: "newMetricETDevTotalEffortDays",
                        },
                        { label: "ET-Dev TC", id: "newMetricETDevTC" },
                        { label: "ET-Dev E%", id: "newMetricETDevE" },
                        { label: "ET-Dev C%", id: "newMetricETDevC" },
                        {
                          label: "ET-QA Total Effort Days",
                          id: "newMetricETQATotalEffortDays",
                        },
                        { label: "ET-QA TC", id: "newMetricETQATC" },
                        { label: "ET-QA E%", id: "newMetricETQAE" },
                        { label: "ET-QA C%", id: "newMetricETQAC" },
                        {
                          label: "AO/TO Total Effort Days",
                          id: "newMetricAOTOTotalEffortDays",
                        },
                        { label: "AO/TO TC", id: "newMetricAOTOTC" },
                        { label: "AO/TO E%", id: "newMetricAOTOE" },
                        { label: "AO/TO C%", id: "newMetricAOTOC" },
                        {
                          label: "PMO Total Effort Days",
                          id: "newMetricPMOTotalEffortDays",
                        },
                        { label: "PMO TC", id: "newMetricPMOTC" },
                        { label: "PMO E%", id: "newMetricPMOE" },
                        { label: "PMO C%", id: "newMetricPMOC" },
                      ];
                      let html = "";
                      for (let i = 0; i < metrics.length; i += 6) {
                        html += `<div style="display: flex; flex-wrap: nowrap; gap: 20px;">`;
                        for (let j = i; j < i + 6 && j < metrics.length; j++) {
                          const m = metrics[j];
                          html += `<div style="flex: 1; min-width: 140px;">
                            <label for="${m.id}">${m.label}</label>
                            <input type="${m.type || "number"}" id="${
                            m.id
                          }" placeholder="${m.type === "date" ? "" : "0"}">
                          </div>`;
                        }
                        html += `</div>`;
                      }
                      return html;
                    })()}
                  </div>
                  <button id="submitMetricBtn">Submit</button>
                </div>
              </div>
              <div style="display: flex; gap: 20px; flex-wrap: nowrap; width: 100vw;">
                <div id="metrics-table-container" style="flex:2.5; min-width:1450px;"></div>
                <div style="flex:0.8; display: flex; flex-direction: column; gap: 20px; min-width:260px; max-width:340px;">
                  <div id="chart-container"></div>
                </div>
              </div>
            </div>`;
          $("addMetricBtn").addEventListener("click", toggleAddMetricForm);
          $("submitMetricBtn").addEventListener("click", submitMetricForm);

          const uploadBtn = document.getElementById("uploadMetricExcelBtn");
          const fileInput = document.getElementById("metricExcelFileInput");
          if (uploadBtn && fileInput) {
            uploadBtn.onclick = function () {
              fileInput.value = "";
              fileInput.click();
            };
            fileInput.onchange = async (e) => {
              const file = e.target.files[0];
              if (!file) return;
              try {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, { type: "array" });

                const scdSheet = wb.Sheets["SCD"];
                let scdIntakeId = "";
                if (scdSheet && scdSheet["E1"] && scdSheet["E1"].v) {
                  scdIntakeId = String(scdSheet["E1"].v).trim();
                }

                let scdIdNum = "";
                if (/^ENT-\d+$/i.test(scdIntakeId)) {
                  scdIdNum = scdIntakeId.replace(/^ENT-/i, "");
                }

                const userIntakeId = document
                  .getElementById("newMetricIntakeId")
                  .value.trim();
                const userIdNum = userIntakeId.replace(/^ENT-/i, "");

                if (!scdIdNum || !userIdNum || scdIdNum !== userIdNum) {
                  alert(
                    'Intake ID in Excel ("' +
                      scdIntakeId +
                      '") does not match the Intake ID field ("' +
                      userIntakeId +
                      '").\nPlease check and try again.'
                  );
                  fileInput.value = "";
                  return;
                }

                const ws = wb.Sheets["Grand Total"];
                if (!ws) {
                  alert('Worksheet "Grant Total" not found.');
                  return;
                }
                const get = (cell) => (ws[cell] ? ws[cell].v : "");
                const percentMapping = [
                  ["G33", "newMetricETBAE"],
                  ["I33", "newMetricETBAC"],
                  ["G34", "newMetricETDevE"],
                  ["I34", "newMetricETDevC"],
                  ["G35", "newMetricETQAE"],
                  ["I35", "newMetricETQAC"],
                  ["G36", "newMetricPMOE"],
                  ["I36", "newMetricPMOC"],
                  ["I37", "newMetricAOTOC"],
                ];
                const mapping = [
                  ["H7", "newMetricTotalOngoingCosts"],
                  ["C19", "newMetricLOBSubTotal"],
                  ["E19", "newMetricContingency"],
                  ["C33", "newMetricETBATotalEffortDays"],
                  ["E33", "newMetricETBATC"],
                  ["C34", "newMetricETDevTotalEffortDays"],
                  ["E34", "newMetricETDevTC"],
                  ["C35", "newMetricETQATotalEffortDays"],
                  ["E35", "newMetricETQATC"],
                  ["C36", "newMetricPMOTotalEffortDays"],
                  ["E36", "newMetricPMOTC"],
                  ["E37", "newMetricAOTOTotalEffortDays"],
                ];
                mapping.forEach(([cell, id]) => {
                  const el = document.getElementById(id);
                  let val = get(cell);
                  if (el) {
                    if (
                      [
                        "newMetricETBATotalEffortDays",
                        "newMetricETDevTotalEffortDays",
                        "newMetricETQATotalEffortDays",
                        "newMetricPMOTotalEffortDays",
                        "newMetricAOTOTotalEffortDays",
                      ].includes(id) &&
                      typeof val === "string"
                    ) {
                      const match = val.match(/^([\d.]+)/);
                      el.value = match ? match[1] : val;
                    } else {
                      el.value = val;
                    }
                  }
                });
                percentMapping.forEach(([cell, id]) => {
                  const el = document.getElementById(id);
                  let val = get(cell);
                  if (el && val !== "") {
                    let num = parseFloat(val);
                    if (!isNaN(num)) {
                      el.value = Math.round(num * 1000) / 10;
                    } else {
                      el.value = val;
                    }
                  }
                });
                alert("Fields populated from Excel.");
              } catch (err) {
                alert("Failed to read Excel file: " + err.message);
              }
              fileInput.value = "";
            };
          }

          const quickDate = $("quickDateDropdown");
          const startDate = $("startDateTotal");
          const endDate = $("endDateTotal");

          quickDate.addEventListener("change", () => {
            const today = new Date();
            let start = "",
              end = "";
            if (quickDate.value === "week") {
              const d = new Date(today);
              d.setDate(d.getDate() - 7);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else if (quickDate.value === "month") {
              const d = new Date(today);
              d.setMonth(d.getMonth() - 1);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else if (quickDate.value === "4months") {
              const d = new Date(today);
              d.setMonth(d.getMonth() - 4);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else if (quickDate.value === "year") {
              const d = new Date(today);
              d.setFullYear(d.getFullYear() - 1);
              start = d.toISOString().split("T")[0];
              end = today.toISOString().split("T")[0];
            } else {
              start = "";
              end = "";
            }
            startDate.value = start;
            endDate.value = end;
            updateChartAndTable($("metric").value);
            updateDisciplineTables();

            if (!$("jrm-content").classList.contains("hidden")) filterCards();
          });

          startDate.addEventListener("input", () => {
            if (quickDate.value) quickDate.value = "";
          });
          endDate.addEventListener("input", () => {
            if (quickDate.value) quickDate.value = "";
          });
        };

        const generateIntakeCards = (data) => {
          $("intake-charts").innerHTML = data.slice(1).reduce((html, row) => {
            const id = normalizeID(row[0]);
            const approvedDate = row.length >= 8 ? row[7] || "N/A" : "N/A";
            return (
              html +
              `
              <div id="data-${id}" class="data" style="display:none; border:1px solid #ddd; margin-bottom:20px; padding:10px; margin-left:24px;">
                <div style="margin-bottom: 15px; font-size: 1em; color: #333;">
                  <strong>Name:</strong> ${
                    state.jrmNameMapping[id] || "N/A"
                  }<br>
                  <strong>Date:</strong> ${
                    state.jrmDateMapping[id] || "N/A"
                  }<br>
                  <strong>Approved Date:</strong> ${
                    state.jrmApprovedMapping[id]
                  }<br>
                  <strong>Comments:</strong> ${
                    state.jrmCommentsMapping[id] || "N/A"
                  }<br>
                  <strong>Tags:</strong> ${state.jrmTagsMapping[id] || "N/A"}
                </div>
                <div style="border:1px solid #ddd; margin:10px; padding:10px;">
                  <h3>ET One Time Estimates Breakdown</h3>
                  <div class="charts-row">${[1, 2, 3, 4]
                    .map(
                      (i) =>
                        `<div id="chart${i}-${id}" class="chart-container"></div>`
                    )
                    .join("")}</div>
                </div>
                <div style="border:1px solid #ddd; margin:10px; padding:10px;">
                  <h3>CPT-LOB Sub-Total & Contingency</h3>
                  <div class="charts-row">${[5]
                    .map(
                      (i) =>
                        `<div id="chart${i}-${id}" class="chart-container"></div>`
                    )
                    .join("")}</div>
                </div>
              </div>`
            );
          }, "");
        };

        const initCharts = (data) => {
          const header = data[0],
            last = header.length,
            contIdx = header.findIndex(
              (h) => h.trim().toLowerCase() === "contingency"
            ),
            startIdx = contIdx + 1;
          data.slice(1).forEach((row) => {
            const id = normalizeID(row[0]);
            let etLabels = [],
              etTFD = [],
              etTC = [],
              etEff = [],
              etCost = [];
            for (let col = startIdx; col < last; col += 4) {
              etLabels.push(
                (header[col] || "").replace(" Total Effort Days", "")
              );
              etTFD.push(row[col] || 0);
              etTC.push(row[col + 1] || 0);
              etEff.push(row[col + 2] || 0);
              etCost.push(row[col + 3] || 0);
            }
            const color = (i) =>
              ["#4a90e2", "#a0c4ff", "#90b0d8", "#7a9cc6", "#6588b4"][i % 5];
            generateChart(
              `chart1-${id}`,
              etLabels,
              etTFD,
              "Total Effort Days",
              etLabels.map((_, i) => color(i + 1))
            );
            generateChart(
              `chart2-${id}`,
              etLabels,
              etTC,
              "Total Costs",
              etLabels.map((_, i) => color(i + 1))
            );
            generateChart(
              `chart3-${id}`,
              etLabels,
              etEff,
              "Effort %",
              etLabels.map((_, i) => color(i + 1))
            );
            generateChart(
              `chart4-${id}`,
              etLabels,
              etCost,
              "Cost %",
              etLabels.map((_, i) => color(i + 1))
            );
            const lob = Number(
                row[
                  header.findIndex(
                    (h) => h.trim().toLowerCase() === "lob sub-total"
                  )
                ] || 0
              ),
              cont = Number(row[contIdx] || 0),
              data5 = [lob, cont, lob + cont],
              labels5 = ["CPT-LOB Sub-Total", "Contingency", "Total"];
            generateChart(
              `chart5-${id}`,
              labels5,
              data5,
              "CPT-LOB Sub-Total & Contingency",
              ["#4a90e2", "#a0c4ff", "#7a9cc6"]
            );
          });
        };

        const generateChart = (id, labels, data, title, colors) => {
          Highcharts.chart(id, {
            chart: { type: "column" },
            title: { text: title },
            xAxis: { categories: labels },
            yAxis: { min: 0, title: { text: "Value" } },
            plotOptions: { column: { stacking: "normal" } },
            series: [
              {
                name: title,
                data: labels.map((_, i) => ({
                  y: parseFloat(data[i]) || 0,
                  color: colors[i],
                })),
              },
            ],
          });
        };

        const renderTable = (
          fixedHeaders,
          metricIndices,
          title,
          start,
          end
        ) => {
          const isET = title === "Metrics for ET";
          let totals = Array(metricIndices.length).fill(0);
          const fixedIndices = fixedHeaders.map((h) => {
            if (h.trim().toLowerCase() === "approved date") return -1;
            return state.tableHeaders.findIndex(
              (x) => x.trim().toLowerCase() === h.trim().toLowerCase()
            );
          });
          let headerHTML = fixedHeaders
            .map((h, i) => {
              if (h.trim().toLowerCase() === "intake id") {
                return `<th class="dropdown-header" data-column="intakeId" data-col-index="${i}" style="position: relative; cursor: pointer;">
                ${h} <span class="dropdown-arrow">&#9662;</span>
                <div class="dropdown-content" style="position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ddd; padding: 5px; display: none; z-index: 1000; min-width: 150px;">
                  <input type="text" class="dropdown-search" placeholder="Search..." style="width:100%; margin-bottom:5px; color: black;">
                  <ul class="dropdown-options" style="list-style: none; margin:0; padding:0; max-height:150px; overflow-y:auto; color: black;"></ul>
                </div>
              </th>`;
              } else {
                return `<th>${h}</th>`;
              }
            })
            .join("");

          metricIndices.forEach((idx) => {
            headerHTML += `<th>${state.tableHeaders[idx]}</th>`;
          });

          if (isLoggedIn) {
            headerHTML += `<th>Admin</th>`;
          }

          let tableHTML = `<h3>${title}</h3><table class="modern-table"><thead><tr>${headerHTML}</tr></thead><tbody>`;
          state.metricsRows.forEach((row) => {
            const id = normalizeID(row[0]);
            const approvedDateValue = state.jrmApprovedMapping[id] || "N/A";
            if (!inRange(approvedDateValue, start, end)) return;

            let rowHTML = "";
            fixedIndices.forEach((idx, i) => {
              const headerKey = fixedHeaders[i].trim().toLowerCase();
              if (headerKey === "approved date") {
                rowHTML += `<td>${approvedDateValue}</td>`;
              } else if (headerKey === "intake id") {
                rowHTML += `<td><a class="intake-link" href="javascript:void(0)" onclick="showData('${id}')">${row[idx]}</a></td>`;
              } else {
                rowHTML += `<td>${row[idx]}</td>`;
              }
            });

            metricIndices.forEach((idx, i) => {
              const cell = row[idx];
              const hdr = state.tableHeaders[idx].toLowerCase().trim();
              totals[i] += parseCur(cell);
              const formatted =
                cell === "" || cell === null || isNaN(parseFloat(cell))
                  ? "-"
                  : idx >
                      state.tableHeaders.findIndex(
                        (h) => h.trim().toLowerCase() === "intake id"
                      ) &&
                    idx <
                      state.tableHeaders.findIndex(
                        (h) => h.trim().toLowerCase() === "contingency"
                      )
                  ? fmtCur(parseCur(cell))
                  : hdr.includes("cpt-lob sub-total") ||
                    hdr.includes("contingency")
                  ? fmtCur(parseCur(cell))
                  : hdr.includes("total cost")
                  ? fmtCur(parseCur(cell))
                  : hdr.includes("effort %")
                  ? parseFloat(cell).toFixed(2) + "%"
                  : hdr.includes("cost %")
                  ? parseFloat(cell).toFixed(2) + "%"
                  : cell;
              rowHTML += `<td>${formatted}</td>`;
            });

            if (isLoggedIn) {
              rowHTML += `<td>
                <button onclick="editMetricRow('${id}')">Edit</button>
                <button onclick="deleteMetricRow('${id}')">Delete</button>
              </td>`;
            }
            tableHTML += `<tr>${rowHTML}</tr>`;
          });

          let totalRow = `<tr><td colspan="${fixedIndices.length}"><strong>Total</strong></td>`;
          metricIndices.forEach((_, i) => {
            const hdr = state.tableHeaders[metricIndices[i]]
                .toLowerCase()
                .trim(),
              fTot =
                hdr.includes("total ongoing costs") ||
                hdr.includes("cpt-lob sub-total") ||
                hdr.includes("contingency") ||
                hdr.includes("total cost")
                  ? fmtCur(totals[i])
                  : hdr.includes("effort %")
                  ? totals[i].toFixed(2) + "%"
                  : hdr.includes("cost %")
                  ? totals[i].toFixed(2) + "%"
                  : totals[i].toLocaleString();
            totalRow += `<td><strong>${fTot}</strong></td>`;
          });
          if (isLoggedIn) totalRow += "<td></td>";
          tableHTML += totalRow + "</tbody></table>";

          $(
            "metrics-table-container"
          ).innerHTML = `<div style="border:2px solid #009879; border-radius:6px; padding:10px; margin-bottom:16px;">
                <div style="max-height:600px; overflow-y:auto;">
                  ${tableHTML}
                </div>
            </div>`;
          initDropdownFilters();
        };

        window.editMetricRow = (normId) => {
          const rowIndex = state.metricsRows.findIndex(
            (row) => normalizeID(row[0]) === normId
          );
          if (rowIndex === -1) return;

          const row = state.metricsRows[rowIndex];
          const headers = state.tableHeaders;

          const editFormHTML = headers
            .map((header, idx) => {
              if (header.trim().toLowerCase() === "intake id") {
                return `<label>${header}: <input type="text" id="edit-${idx}" value="${
                  row[idx] || ""
                }" readonly></label><br>`;
              } else if (header.trim().toLowerCase() === "intake name") {
                return `<label>${header}: <input type="text" id="edit-${idx}" value="${
                  row[idx] || ""
                }" readonly></label><br>`;
              } else {
                return `<label>${header}: <input type="text" id="edit-${idx}" value="${
                  row[idx] || ""
                }"></label><br>`;
              }
            })
            .join("");

          const approvedDate = state.jrmApprovedMapping[normId] || "";
          const approvedDateField = `
            <label>Approved Date: <input type="date" id="edit-approved-date" value="${
              approvedDate && !isNaN(new Date(approvedDate))
                ? new Date(approvedDate).toISOString().split("T")[0]
                : ""
            }"></label><br>
          `;

          const modalHTML = `

            <div id="editModal" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:1px solid #ccc;z-index:1000;">
              <h3>Edit Metric Row</h3>
              ${editFormHTML}
              ${approvedDateField}
              <button onclick="saveMetricRow('${normId}')">Save</button>
              <button onclick="closeEditModal()">Cancel</button>
            </div>
          `;

          const modalContainer = document.createElement("div");
          modalContainer.id = "modalContainer";
          modalContainer.innerHTML = modalHTML;
          document.body.appendChild(modalContainer);
        };

        window.saveMetricRow = async (normId) => {
          // Find which row we’re editing
          const rowIndex = state.metricsRows.findIndex(
            (row) => normalizeID(row[0]) === normId
          );
          if (rowIndex === -1) return;

          // 1) Validate numeric fields
          const isNumeric = (val) => val === "" || !isNaN(val);
          for (let idx = 0; idx < state.tableHeaders.length; idx++) {
            const header = state.tableHeaders[idx].trim().toLowerCase();
            if (header === "intake id" || header === "intake name") continue;
            const input = document.getElementById(`edit-${idx}`);
            if (input && !isNumeric(input.value)) {
              alert(
                `Invalid value for "${state.tableHeaders[idx]}". Please enter a number.`
              );
              input.focus();
              return;
            }
          }

          // 2) Define a precise header→payload-key map
          const headerToKey = {
            "Intake ID": "intakeId",
            "Intake Name": "intakeName",
            "Total Ongoing Costs": "totalOngoingCosts",
            "CPT-LOB Sub-Total": "lobSubTotal",
            Contingency: "contingency",

            "ET-BA Total Effort Days": "etBATotalEffortDays",
            "ET-BA Total Cost": "etBATC",
            "ET-BA Effort %": "etBAEPercent",
            "ET-BA Cost %": "etBACPercent",

            "ET-Dev Total Effort Days": "etDevTotalEffortDays",
            "ET-Dev Total Cost": "etDevTC",
            "ET-Dev Effort %": "etDevEPercent",
            "ET-Dev Cost %": "etDevCPercent",

            "ET-QA Total Effort Days": "etQATotalEffortDays",
            "ET-QA Total Cost": "etQATC",
            "ET-QA Effort %": "etQAEPercent",
            "ET-QA Cost %": "etQACPercent",

            "AO/TO Total Effort Days": "aotoTotalEffortDays",
            "AO/TO Total Cost": "aotoTC",
            "AO/TO Effort %": "aotoEPercent",
            "AO/TO Cost %": "aotoCPercent",

            "PMO Total Effort Days": "pmoTotalEffortDays",
            "PMO Total Cost": "pmoTC",
            "PMO Effort %": "pmoEPercent",
            "PMO Cost %": "pmoCPercent",
          };

          // 3) Build the JSON payload
          const payload = {};
          state.tableHeaders.forEach((header, idx) => {
            const key = headerToKey[header.trim()];
            if (!key || key === "intakeId" || key === "intakeName") return;
            const rawVal = document.getElementById(`edit-${idx}`).value;
            if (rawVal !== "") {
              payload[key] = isNaN(rawVal) ? rawVal : Number(rawVal);
            }
          });

          // Include approvedDate if changed
          const dateVal = document.getElementById("edit-approved-date").value;
          if (dateVal) {
            payload.approvedDate = dateVal;
          }

          // If no fields changed, bail out
          if (Object.keys(payload).length === 0) {
            alert("No changes to save.");
            closeEditModal();
            return;
          }

          // 4) Send the PUT request
          try {
            console.log("PUT payload:", payload); // Inspect in DevTools
            const response = await fetch(`/metrics/ENT-${normId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || "Update failed");
            }

            // 5) Merge updated values into front-end state
            // Update metricsRows
            state.metricsRows[rowIndex] = state.tableHeaders.map(
              (header, idx) => {
                const input = document.getElementById(`edit-${idx}`);
                return input ? input.value : "";
              }
            );

            // Update approved date in JRM rows/UI
            if (payload.approvedDate) {
              const displayDate = new Date(
                payload.approvedDate
              ).toLocaleDateString();
              state.jrmApprovedMapping[normId] = displayDate;
              state.jrmRows = state.jrmRows.map((r) => {
                if (normalizeID(r[0]) === normId) {
                  r[7] = new Date(payload.approvedDate);
                }
                return r;
              });
            }

            // Refresh UI & close modal
            closeEditModal();
            updateDisciplineTables();
            changeCount++;
            logChange(`Edited Metric row for Intake <b>ENT-${normId}</b>`);
            updateChangeCounterDisplay();
          } catch (err) {
            console.error(err);
            alert("Error saving metrics: " + err.message);
          }
        };

        window.closeEditModal = () => {
          const modalContainer = document.getElementById("modalContainer");
          if (modalContainer) modalContainer.remove();
        };

        window.deleteMetricRow = (normId) => {
          state.metricsRows = state.metricsRows.filter(
            (row) => normalizeID(row[0]) !== normId
          );
          state.rawMetrics = [state.rawMetrics[0]].concat(
            state.rawMetrics
              .slice(1)
              .filter((row) => normalizeID(row[0]) !== normId)
          );
          state.metricsIDs.delete(normId);
          updateDisciplineTables();
          updateMetricSelect();
          changeCount++;
          logChange(`Deleted Metric row for Intake <b>ENT-${normId}</b>`);
          fetch(`/metrics/ENT-${normId}`, {
            method: "DELETE",
          })
            .then((response) => {
              if (!response.ok)
                throw new Error(`Delete failed: ${response.statusText}`);
              return response.json();
            })
            .then((data) => {
              console.log("Delete successful:", data);
            })
            .catch((error) => {
              console.error("Error deleting intake:", error);
            });
        };

        const initDropdownFilters = () => {
          $$(".dropdown-header").forEach((th) => {
            const column = th.getAttribute("data-column"),
              dropdown = th.querySelector(".dropdown-content"),
              searchInput = dropdown.querySelector(".dropdown-search"),
              optionsList = dropdown.querySelector(".dropdown-options");
            let values =
              column === "intakeId"
                ? state.metricsRows.map((r) => r[0])
                : state.metricsRows.map((r) => r[1]);
            values = Array.from(new Set(values)).sort();
            values.unshift("All");
            optionsList.innerHTML = "";
            values.forEach((val) => {
              const li = document.createElement("li");
              li.textContent = val;
              li.style.padding = "4px";
              li.style.cursor = "pointer";
              li.addEventListener("click", (e) => {
                e.stopPropagation();
                filterTableByColumn(column, val);
                dropdown.style.display = "none";
              });
              optionsList.appendChild(li);
            });
            th.addEventListener("click", (e) => {
              $$(".dropdown-content").forEach((dc) => {
                if (dc !== dropdown) dc.style.display = "none";
              });
              dropdown.style.display =
                dropdown.style.display === "block" ? "none" : "block";
              e.stopPropagation();
            });
            searchInput.addEventListener("keyup", (e) => {
              const searchTerm = e.target.value.toLowerCase();
              optionsList
                .querySelectorAll("li")
                .forEach(
                  (li) =>
                    (li.style.display = li.textContent
                      .toLowerCase()
                      .includes(searchTerm)
                      ? "block"
                      : "none")
                );
            });
            dropdown.addEventListener("click", (e) => e.stopPropagation());
          });
          document.addEventListener("click", () =>
            $$(".dropdown-content").forEach((dc) => (dc.style.display = "none"))
          );
        };

        const filterTableByColumn = (column, value) => {
          const table = document.querySelector("table.modern-table");
          if (!table) return;
          const header = table.querySelector(`th[data-column="${column}"]`),
            colIndex = header
              ? parseInt(header.getAttribute("data-col-index"))
              : 0,
            tbody = table.querySelector("tbody");
          Array.from(tbody.rows).forEach((row) => {
            const cellValue = row.cells[colIndex].textContent.trim();
            row.style.display =
              value === "All" || cellValue === value ? "" : "none";
          });
        };

        const updateMetricSelect = () => {
          const sel = $("metric");
          sel.innerHTML = "";
          if (!OTHER.some((d) => $(d + "Checkbox")?.checked)) {
            const intakeNameIdx = state.tableHeaders.findIndex(
                (h) => h.trim().toLowerCase() === "intake name"
              ),
              contIdx = state.tableHeaders.findIndex(
                (h) => h.trim().toLowerCase() === "contingency"
              );
            const defs =
              intakeNameIdx !== -1 &&
              contIdx !== -1 &&
              contIdx >= intakeNameIdx + 1
                ? state.tableHeaders.slice(intakeNameIdx + 1, contIdx + 1)
                : ["Total Ongoing Costs", "CPT-LOB Sub-Total", "Contingency"];
            defs.forEach((metric) =>
              sel.appendChild(createOption(metric, metric))
            );
            sel.onchange = () => {
              updateChartAndTable(sel.value);
              updateDisciplineTables();
            };
            if (sel.options.length) {
              updateChartAndTable(sel.options[0].value);
            } else {
              $("chart-container").innerHTML = "";
            }
            updateDisciplineTables();
            return;
          }
          const selected = OTHER.filter((d) => $(d + "Checkbox")?.checked).map(
              (d) => (d === "aoto" ? "ao/to" : d)
            ),
            opts = selected.length
              ? state.metricOptions.filter((opt) =>
                  selected.some((d) => opt.toLowerCase().includes(d))
                )
              : state.metricOptions.filter(
                  (opt) =>
                    !["intake id", "intake name"].includes(
                      opt.trim().toLowerCase()
                    )
                );
          opts.forEach((opt) => sel.appendChild(createOption(opt, opt)));
          sel.onchange = () => {
            updateChartAndTable(sel.value);
            updateDisciplineTables();
          };
          if (sel.options.length) {
            updateChartAndTable(sel.options[0].value);
          } else {
            $("chart-container").innerHTML = "";
          }
          updateDisciplineTables();
        };

        const updateDisciplineTables = () => {
          const start = $("startDateTotal").value,
            end = $("endDateTotal").value,
            fixed = ["Approved Date", "Intake ID", "Intake Name"];
          if (!OTHER.some((d) => $(d + "Checkbox")?.checked)) {
            const intakeNameIdx = state.tableHeaders.findIndex(
                (h) => h.trim().toLowerCase() === "intake name"
              ),
              contIdx = state.tableHeaders.findIndex(
                (h) => h.trim().toLowerCase() === "contingency"
              );
            const headers =
              intakeNameIdx !== -1 && contIdx !== -1 && contIdx > intakeNameIdx
                ? state.tableHeaders.slice(intakeNameIdx + 1, contIdx + 1)
                : [];
            const indices = headers.map((h) =>
              state.tableHeaders.findIndex(
                (x) => x.trim().toLowerCase() === h.trim().toLowerCase()
              )
            );
            if (!indices.length) return;
            renderTable(fixed, indices, "Metrics Table", start, end);
            return;
          }
          const checked = OTHER.filter((d) => $(d + "Checkbox")?.checked),
            indices = [];
          for (let i = 2; i < state.tableHeaders.length; i++) {
            const hdr = state.tableHeaders[i].toLowerCase().trim();
            if (checked.map((d) => dp[d]).some((p) => hdr.includes(p)))
              indices.push(i);
          }
          if (!indices.length) return;
          renderTable(
            fixed,
            indices,
            `Selected: ${checked.map((d) => d.toUpperCase()).join(", ")}`,
            start,
            end
          );
        };

        const clearFilters = () => {
          OTHER.forEach((d) => {
            if ($(d + "Checkbox")) $(d + "Checkbox").checked = false;
          });
          ["startDateTotal", "endDateTotal"].forEach(
            (id) => ($(id).value = "")
          );
          updateMetricSelect();
        };

        const updateChartAndTable = (metricForPie) => {
          $("metrics-table-container").classList.remove("hidden");
          $("chart-container").classList.remove("hidden");

          const metricForTable = $("metric").value || metricForPie;
          const col = state.metricMapping[metricForTable],
            start = $("startDateTotal").value,
            end = $("endDateTotal").value,
            filtered = state.metricsRows.filter((row) => {
              const dt = state.jrmApprovedMapping[normalizeID(row[0])];
              return (!start && !end) || (dt && inRange(dt, start, end));
            });

          renderTable(
            ["Approved Date", "Intake ID", "Intake Name"],
            [col],
            "Metrics Table",
            start,
            end
          );

          let summaryRows = [];
          if (!OTHER.some((d) => $(d + "Checkbox")?.checked)) {
            const lobIdx = state.tableHeaders.findIndex(
              (h) => h.trim().toLowerCase() === "cpt-lob sub-total"
            );
            const contIdx = state.tableHeaders.findIndex(
              (h) => h.trim().toLowerCase() === "contingency"
            );
            let lobTotal = 0,
              contTotal = 0;
            filtered.forEach((row) => {
              lobTotal += parseCur(row[lobIdx]);
              contTotal += parseCur(row[contIdx]);
            });
            summaryRows.push(
              `<tr><td>Grand Total</td><td><strong>${fmtCur(
                lobTotal + contTotal
              )}</strong></td></tr>`
            );

            summaryRows.unshift("<tr><th>Metric</th><th>Total</th></tr>");
          } else {
            const checked = OTHER.filter((d) => $(d + "Checkbox")?.checked);

            let tfdIdxs = [],
              tcIdxs = [],
              eIdxs = [],
              cIdxs = [],
              totalCostIdxs = [];
            checked.forEach((d) => {
              const prefix = dp[d];
              tfdIdxs.push(
                state.tableHeaders.findIndex((h) =>
                  h.toLowerCase().includes(prefix + " total effort days")
                )
              );
              tcIdxs.push(
                state.tableHeaders.findIndex((h) =>
                  h.toLowerCase().includes(prefix + " tc")
                )
              );
              eIdxs.push(
                state.tableHeaders.findIndex((h) =>
                  h.toLowerCase().includes(prefix + " effort %")
                )
              );
              cIdxs.push(
                state.tableHeaders.findIndex((h) =>
                  h.toLowerCase().includes(prefix + " cost %")
                )
              );

              totalCostIdxs.push(
                state.tableHeaders.findIndex((h) =>
                  h.toLowerCase().includes(prefix + " total cost")
                )
              );
            });

            tfdIdxs = tfdIdxs.filter((i) => i !== -1);
            eIdxs = eIdxs.filter((i) => i !== -1);
            cIdxs = cIdxs.filter((i) => i !== -1);
            totalCostIdxs = totalCostIdxs.filter((i) => i !== -1);

            let tfd = 0,
              e = 0,
              c = 0,
              totalCost = 0,
              count = 0;
            filtered.forEach((row) => {
              tfdIdxs.forEach((idx) => {
                tfd += parseCur(row[idx]);
              });
              eIdxs.forEach((idx) => {
                e += parseCur(row[idx]);
              });
              cIdxs.forEach((idx) => {
                c += parseCur(row[idx]);
              });
              totalCostIdxs.forEach((idx) => {
                totalCost += parseCur(row[idx]);
              });
              count++;
            });

            summaryRows = [
              `<tr><td>Total Effort Days</td><td><strong>${tfd.toLocaleString()}</strong></td></tr>`,
              `<tr><td>Total Cost</td><td><strong>${fmtCur(
                totalCost
              )}</strong></td></tr>`,
              `<tr><td>Effort %</td><td><strong>${e.toFixed(
                2
              )}%</strong></td></tr>`,
              `<tr><td>Cost %</td><td><strong>${c.toFixed(
                2
              )}%</strong></td></tr>`,
            ];
            summaryRows.unshift("<tr><th>Metric</th><th>Total</th></tr>");
          }
        };

        function updatePieChart(metric, filtered) {
          const col = state.metricMapping[metric];
          if (!filtered.length) {
            $("pie-chart").innerHTML =
              "<p>No data available for selected date range.</p>";
            return;
          }
          const top5 = filtered
              .map((row) => ({
                name: "ENT-" + normalizeID(row[0]),
                y: parseFloat(String(row[col]).replace(/[^\d.\-]/g, "")) || 0,
              }))
              .sort((a, b) => b.y - a.y)
              .slice(0, 5),
            isPercent = metric.includes("%"),
            isPlain = metric.includes("Total Effort Days"),
            isCurrency = !isPercent && !isPlain,
            ttFormat = isPercent
              ? "<b>{point.name}</b><br/>Value: <b>{point.y:.2f}%</b> ({point.percentage:.1f}%)"
              : isCurrency
              ? "<b>{point.name}</b><br/>Value: <b>${point.y:,.2f}</b> ({point.percentage:.1f}%)"
              : "<b>{point.name}</b><br/>Value: <b>{point.y:,.2f}</b> ({point.percentage:.1f}%)";

          Highcharts.chart("pie-chart", {
            chart: { type: "pie" },
            title: { text: "" },
            series: [{ name: "Value", data: top5 }],
            tooltip: { headerFormat: "", pointFormat: ttFormat },
            plotOptions: {
              pie: {
                allowPointSelect: true,
                cursor: "pointer",
                size: "50%",
              },
            },
          });
        }

        function showExportModal() {
          $("exportModal").style.display = "block";
        }
        function hideExportModal() {
          $("exportModal").style.display = "none";
        }
        document.addEventListener("DOMContentLoaded", function () {
          $("exportExcelBtn").onclick = function () {
            hideExportModal();
            exportAll("excel");
          };
          $("exportPdfBtn").onclick = function () {
            hideExportModal();
            exportAll("pdf");
          };
          $("closeExportModalBtn").onclick = hideExportModal;
        });

        const toggleAddIntakeForm = () => {
          $("addIntakeFormContainer").style.display =
            $("addIntakeFormContainer").style.display === "none" ||
            !$("addIntakeFormContainer").style.display
              ? "block"
              : "none";
        };

        const submitIntakeForm = () => {
          const idVal = $("newIntakeId").value.trim();
          const normId = normalizeID(idVal);
          if (!idVal) return alert("Please enter an Intake ID.");
          if (state.jrmNameMapping[normId])
            return alert("This Intake ID already exists.");

          const nameVal = $("newIntakeName").value.trim();
          const commentsVal = $("newIntakeComments").value.trim();
          const tagsVal = $("newIntakeTags").value.trim();
          const dateVal = $("newIntakeDate").value;
          if (!dateVal) return alert("Please select a Date.");

          const newRow = [
            "ENT-" + normId,
            nameVal,
            commentsVal,
            tagsVal,
            "jrm",
            "",
            new Date(dateVal + "T00:00"),
            "",
          ];

          state.jrmRows.push(newRow);
          state.jrmNameMapping[normId] = nameVal;
          state.jrmDateMapping[normId] = formatUIDate(newRow[6]);
          state.jrmApprovedMapping[normId] = "N/A";
          state.jrmCommentsMapping[normId] = commentsVal;
          state.jrmTagsMapping[normId] = tagsVal;

          fetch("/jrm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              intakeId: "ENT-" + normId,
              intakeName: nameVal,
              intakeComments: commentsVal,
              intakeTags: tagsVal,
              status: "jrm",
              attachment: "",
              date: $("newIntakeDate").value, // ISO date string, e.g. "2025-07-11"
              approvedDate: null, // or whatever default
            }),
          })
            .then((r) =>
              r.ok
                ? console.log("JRM insert succeeded")
                : console.error("JRM insert failed", r.statusText)
            )
            .catch((err) => console.error("Network error:", err));

          const newCardHTML = `<div class="jrm-card" data-intake-id="ENT-${normId}" data-intake-name="${nameVal}" data-intake-tags="${tagsVal}" data-intake-date="${formatUIDate(
            newRow[6]
          )}" data-status="jrm" data-closed="false">
                                  <h3><a href="https://jira.cibcatl.com/browse/ENT-${normId}" target="_blank">ENT-${normId} - ${nameVal}</a></h3>
                                  <p><strong>Date:</strong> ${formatUIDate(
                                    newRow[6]
                                  )}</p>
                                  <p><strong>Approved Date:</strong> N/A</p>
                                  <p><strong>Comments:</strong> ${commentsVal}</p>
                                  <p><strong>Tags:</strong> ${tagsVal}</p>
                                </div>`;
          $("jrm-col").innerHTML += newCardHTML;

          [
            "newIntakeId",
            "newIntakeName",
            "newIntakeComments",
            "newIntakeTags",
            "newIntakeDate",
          ].forEach((id) => ($(id).value = ""));
          $("addIntakeFormContainer").style.display = "none";
          filterCards();
          initCardContextMenu();
          changeCount++;
          logChange(`Added new Intake <b>ENT-${normId}</b>`);
          updateChangeCounterDisplay();
        };

        const toggleAddMetricForm = () => {
          $("addMetricFormContainer").style.display =
            $("addMetricFormContainer").style.display === "none" ||
            !$("addMetricFormContainer").style.display
              ? "block"
              : "none";
        };

        const submitMetricForm = () => {
          const intakeId = $("newMetricIntakeId").value.trim();
          const normId = normalizeID(intakeId);
          if (!intakeId) {
            alert("Please enter an Intake ID.");
            return;
          }
          if (state.metricsIDs.has(normId)) {
            alert("This Intake ID already exists in Metrics.");
            return;
          }
          const linkedName = state.jrmNameMapping[normId];
          if (!linkedName) {
            alert(
              "This Intake ID does not exist in the JRM sheet. Please add it using the Add Intake form first."
            );
            return;
          }

          const approvedDateInput = $("newMetricApprovedDate").value;
          if (!approvedDateInput) {
            alert("Please select an Approved Date in the Metric form.");
            return;
          }

          const getVal = (id) => $(id).value || "0";

          const dbRow = [
            "ENT-" + normId,
            getVal("newMetricTotalOngoingCosts"),
            getVal("newMetricLOBSubTotal"),
            getVal("newMetricContingency"),
            getVal("newMetricETBATotalEffortDays"),
            getVal("newMetricETBATC"),
            getVal("newMetricETBAE"),
            getVal("newMetricETBAC"),
            getVal("newMetricETDevTotalEffortDays"),
            getVal("newMetricETDevTC"),
            getVal("newMetricETDevE"),
            getVal("newMetricETDevC"),
            getVal("newMetricETQATotalEffortDays"),
            getVal("newMetricETQATC"),
            getVal("newMetricETQAE"),
            getVal("newMetricETQAC"),
            getVal("newMetricAOTOTotalEffortDays"),
            getVal("newMetricAOTOTC"),
            getVal("newMetricAOTOE"),
            getVal("newMetricAOTOC"),
            getVal("newMetricPMOTotalEffortDays"),
            getVal("newMetricPMOTC"),
            getVal("newMetricPMOE"),
            getVal("newMetricPMOC"),
          ];

          const uiRow = dbRow.slice();
          uiRow.splice(1, 0, linkedName);

          state.rawMetrics.push(dbRow);
          state.metricsRows.push(uiRow);
          state.metricsIDs.add(normId);

          const newApprovedISO = approvedDateInput;
          const newApprovedDateObj = new Date(newApprovedISO + "T00:00");

          const displayApprovedDate = formatUIDate(newApprovedDateObj);

          state.jrmRows = state.jrmRows.map((row) => {
            if (normalizeID(row[0]) === normId) {
              row[7] = newApprovedDateObj;
              state.jrmApprovedMapping[normId] = displayApprovedDate;
            }
            return row;
          });

          const cardEl = document.querySelector(
            `.jrm-card[data-intake-id="ENT-${normId}"]`
          );
          if (cardEl) {
            const approvedDateParagraph = Array.from(
              cardEl.querySelectorAll("p")
            ).find((p) => p.textContent.includes("Approved Date:"));
            if (approvedDateParagraph) {
              approvedDateParagraph.innerHTML = `<strong>Approved Date:</strong> ${displayApprovedDate}`;
            }
          }

          fetch("/metrics", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              intakeId: `ENT-${normId}`,
              intakeName: linkedName,

              totalOngoingCosts: parseFloat(
                getVal("newMetricTotalOngoingCosts")
              ),
              lobSubTotal: parseFloat(getVal("newMetricLOBSubTotal")),
              contingency: parseFloat(getVal("newMetricContingency")),

              etBATotalEffortDays: parseFloat(
                getVal("newMetricETBATotalEffortDays")
              ),
              etBATC: parseFloat(getVal("newMetricETBATC")),
              etBAEPercent: parseFloat(getVal("newMetricETBAE")),
              etBACPercent: parseFloat(getVal("newMetricETBAC")),

              etDevTotalEffortDays: parseFloat(
                getVal("newMetricETDevTotalEffortDays")
              ),
              etDevTC: parseFloat(getVal("newMetricETDevTC")),
              etDevEPercent: parseFloat(getVal("newMetricETDevE")),
              etDevCPercent: parseFloat(getVal("newMetricETDevC")),

              etQATotalEffortDays: parseFloat(
                getVal("newMetricETQATotalEffortDays")
              ),
              etQATC: parseFloat(getVal("newMetricETQATC")),
              etQAEPercent: parseFloat(getVal("newMetricETQAE")),
              etQACPercent: parseFloat(getVal("newMetricETQAC")),

              aotoTotalEffortDays: parseFloat(
                getVal("newMetricAOTOTotalEffortDays")
              ),
              aotoTC: parseFloat(getVal("newMetricAOTOTC")),
              aotoEPercent: parseFloat(getVal("newMetricAOTOE")),
              aotoCPercent: parseFloat(getVal("newMetricAOTOC")),

              pmoTotalEffortDays: parseFloat(
                getVal("newMetricPMOTotalEffortDays")
              ),
              pmoTC: parseFloat(getVal("newMetricPMOTC")),
              pmoEPercent: parseFloat(getVal("newMetricPMOE")),
              pmoCPercent: parseFloat(getVal("newMetricPMOC")),

              approvedDate: approvedDateInput, // e.g. "2025-07-12"
            }),
          }).then(async (res) => {
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || res.statusText);
            console.log("Metrics saved:", data);
            alert(`Metrics saved on server for ENT-${normId}!`);
          });

          updateDisciplineTables();
          updateMetricSelect();

          [
            "newMetricIntakeId",
            "newMetricApprovedDate",
            "newMetricTotalOngoingCosts",
            "newMetricLOBSubTotal",
            "newMetricContingency",
            "newMetricETBATotalEffortDays",
            "newMetricETBATC",
            "newMetricETBAE",
            "newMetricETBAC",
            "newMetricETDevTotalEffortDays",
            "newMetricETDevTC",
            "newMetricETDevE",
            "newMetricETDevC",
            "newMetricETQATotalEffortDays",
            "newMetricETQATC",
            "newMetricETQAE",
            "newMetricETQAC",
            "newMetricAOTOTotalEffortDays",
            "newMetricAOTOTC",
            "newMetricAOTOE",
            "newMetricAOTOC",
            "newMetricPMOTotalEffortDays",
            "newMetricPMOTC",
            "newMetricPMOE",
            "newMetricPMOC",
          ].forEach((id) => ($(id).value = ""));

          $("addMetricFormContainer").style.display = "none";
          changeCount++;
          logChange(`Added Metric row for Intake <b>ENT-${normId}</b>`);
          updateChangeCounterDisplay();
          alert("Metric row added successfully!");
        };

        const saveFile = async () => {
          const fileName = prompt(
            "Enter file name for the exported xlsx:\nLink to Database: https://github.cibcdevops.com/Parthiv-Patel1/IntakePipline/tree/master/Database",
            "Intake_Database_V.xlsx"
          );
          if (!fileName) return;
          const wb = XLSX.utils.book_new();

          const jrmData = state.jrmHeader
            ? [state.jrmHeader, ...state.jrmRows]
            : [];
          const wsJRM = XLSX.utils.aoa_to_sheet(jrmData);
          XLSX.utils.book_append_sheet(wb, wsJRM, "JRM");

          const desiredHeaders = [
            "Intake ID",
            "Total Ongoing Costs",
            "LOB Sub-Total",
            "Contingency",
            "ET-BA Total Effort Days",
            "ET-BA TC",
            "ET-BA E%",
            "ET-BA C%",
            "ET-Dev Total Effort Days",
            "ET-Dev TC",
            "ET-Dev E%",
            "ET-Dev C%",
            "ET-QA Total Effort Days",
            "ET-QA TC",
            "ET-QA E%",
            "ET-QA C%",
            "AO/TO Total Effort Days",
            "AO/TO TC",
            "AO/TO E%",
            "AO/TO C%",
            "PMO Total Effort Days",
            "PMO TC",
            "PMO E%",
            "PMO C%",
          ];

          const headerRow = state.rawMetrics[0];
          const colIndices = desiredHeaders.map((h) => {
            let idx = headerRow.indexOf(h);
            if (idx === -1) {
              idx = headerRow.findIndex(
                (x) => String(x).trim().toLowerCase() === h.trim().toLowerCase()
              );
            }
            return idx;
          });

          const metricsData = [
            desiredHeaders,
            ...state.rawMetrics
              .slice(1)
              .map((row) =>
                colIndices.map((idx) => (idx !== -1 ? row[idx] : ""))
              ),
          ];
          const wsMetrics = XLSX.utils.aoa_to_sheet(metricsData);
          XLSX.utils.book_append_sheet(wb, wsMetrics, "Metrics");

          XLSX.writeFile(wb, fileName);
          changeCount = 0;
          changeLog.length = 0;
          updateChangeCounterDisplay();
        };

        const filterCards = () => {
          const input = $("searchInput").value.toLowerCase(),
            start = $("startDate").value,
            end = $("endDate").value,
            status = $("statusDropdown").value,
            cards = $$(".jrm-card");
          let count = 0;
          cards.forEach((card) => {
            const id = card.getAttribute("data-intake-id").toLowerCase(),
              name = card.getAttribute("data-intake-name").toLowerCase(),
              tags = card.getAttribute("data-intake-tags").toLowerCase(),
              searchOk =
                id.includes(input) ||
                name.includes(input) ||
                tags.includes(input),
              cardDate = card.getAttribute("data-intake-date"),
              cardDateObj = parseDMY(cardDate),
              startDateObj = start ? new Date(start) : null,
              endDateObj = end ? new Date(end) : null,
              dateOk =
                (!startDateObj || cardDateObj >= startDateObj) &&
                (!endDateObj ||
                  cardDateObj <= endDateObj.setDate(endDateObj.getDate() + 1)),
              closed = card.getAttribute("data-closed"),
              cardStatus = card.getAttribute("data-status");
            if (status === "ofs") {
              card.style.display =
                cardStatus === "ofs" && searchOk && dateOk ? "" : "none";
              if (card.style.display === "") count++;
            } else {
              if (cardStatus === "ofs") card.style.display = "none";
              else {
                card.style.display =
                  (status === "all" ||
                    (status === "closed" && closed === "true")) &&
                  searchOk &&
                  dateOk
                    ? ""
                    : "none";
                if (card.style.display === "") count++;
              }
            }
            $("non-ofs-container").style.display =
              status === "ofs" ? "none" : "block";
            $("ofs-wrapper").style.display =
              status === "ofs" ? "block" : "none";
            $("counter").innerText = "Intakes Count: " + count;
          });
        };

        function transformPassword(input, mode) {
          const key = "pnbbpm";
          let result = "";
          input = input.toLowerCase();
          for (let i = 0; i < input.length; i++) {
            let charCode = input.charCodeAt(i) - 97;
            let keyCode = key.charCodeAt(i % key.length) - 97;
            let newCode;
            if (mode === "encrypt") {
              newCode = (charCode + keyCode) % 26;
            } else if (mode === "decrypt") {
              newCode = (charCode - keyCode + 26) % 26;
            } else {
              throw new Error("Invalid mode. Use 'encrypt' or 'decrypt'.");
            }
            result += String.fromCharCode(newCode + 97);
          }
          return result;
        }

        window.showData = (id) => {
          const target = $("data-" + id);
          if (target) {
            ["total-content", "jrm-content"].forEach((sec) =>
              $(sec).classList.add("hidden")
            );
            $("intake-charts").classList.remove("hidden");
            let hdr =
              $("chart-header") ||
              Object.assign(document.createElement("h2"), {
                id: "chart-header",
              });
            if (!hdr.parentNode) $("intake-charts").prepend(hdr);
            hdr.textContent = "Intake ID: ENT-" + id;
            hdr.style.marginLeft = "24px";
            $$("#intake-charts .data").forEach(
              (div) => (div.style.display = "none")
            );
            target.style.display = "block";
            setTimeout(() => window.dispatchEvent(new Event("resize")), 100);
          } else alert(`No chart data available for intake ENT-${id}`);
        };

        function renderDashboard(
          selectedRange = "all",
          dashboardType = "executive"
        ) {
          function getAllTags() {
            const tagSet = new Set();
            state.jrmRows.forEach((row) => {
              const tags = (row[3] || "").split(",");
              tags.forEach((tag) => {
                const t = tag.trim();
                if (t) tagSet.add(t);
              });
            });
            return Array.from(tagSet).sort((a, b) => a.localeCompare(b));
          }

          const allTags = getAllTags();
          const selectedTag = window.dashboardSelectedTag || "";

          function rowHasTag(row, tag) {
            if (!tag) return true;
            const tags = (row[3] || "").toLowerCase();
            return tags.includes(tag.toLowerCase());
          }

          function addMonths(date, months) {
            const d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
          }
          function addDays(date, days) {
            const d = new Date(date);
            d.setDate(d.getDate() + days);
            return d;
          }

          let now = new Date();
          let startDate,
            endDate,
            prevStart,
            prevEnd,
            rangeLabel = "",
            prevRangeLabel = "";
          if (selectedRange === "month") {
            endDate = now;
            startDate = addMonths(now, -1);
            prevEnd = addDays(startDate, -1);
            prevStart = addMonths(startDate, -1);
            rangeLabel = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            prevRangeLabel = `${prevStart.toLocaleDateString()} - ${prevEnd.toLocaleDateString()}`;
          } else if (selectedRange === "4months") {
            endDate = now;
            startDate = addMonths(now, -4);
            prevEnd = addDays(startDate, -1);
            prevStart = addMonths(startDate, -4);
            rangeLabel = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            prevRangeLabel = `${prevStart.toLocaleDateString()} - ${prevEnd.toLocaleDateString()}`;
          } else if (selectedRange === "year") {
            endDate = now;
            startDate = addMonths(now, -12);
            prevEnd = addDays(startDate, -1);
            prevStart = addMonths(startDate, -12);
            rangeLabel = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            prevRangeLabel = `${prevStart.toLocaleDateString()} - ${prevEnd.toLocaleDateString()}`;
          } else if (selectedRange === "custom") {
            const customStart = window.dashboardCustomStart;
            const customEnd = window.dashboardCustomEnd;

            const prevCustomStart = window.dashboardPrevCustomStart;
            const prevCustomEnd = window.dashboardPrevCustomEnd;
            if (customStart && customEnd) {
              startDate = new Date(customStart);
              endDate = new Date(customEnd);

              if (prevCustomStart && prevCustomEnd) {
                prevStart = new Date(prevCustomStart);
                prevEnd = new Date(prevCustomEnd);
              } else {
                prevEnd = null;
                prevStart = null;
              }
              rangeLabel = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
              prevRangeLabel =
                prevStart && prevEnd
                  ? `${prevStart.toLocaleDateString()} - ${prevEnd.toLocaleDateString()}`
                  : "";
            } else {
              startDate = null;
              endDate = null;
              prevStart = null;
              prevEnd = null;
              rangeLabel = "All Time";
              prevRangeLabel = "";
            }
          } else {
            startDate = null;
            endDate = null;
            prevStart = null;
            prevEnd = null;
            rangeLabel = "All Time";
            prevRangeLabel = "";
          }

          function filterRows(rows, s, e, status = null) {
            if (!s || !e) return rows;
            return rows.filter((r) => {
              let d;
              if (status === "approved" && state.jrmApprovedMapping) {
                const id = normalizeID(r[0]);
                d = new Date(state.jrmApprovedMapping[id]);
              } else {
                d = r[6];
              }
              if (!(d instanceof Date) || isNaN(d)) return false;
              const eDate = e ? new Date(e) : null;
              return d >= s && d <= eDate.setDate(eDate.getDate() + 1);
            });
          }

          let filteredRows = filterRows(
            state.jrmRows,
            startDate,
            endDate
          ).filter((r) => rowHasTag(r, selectedTag));
          let prevRows = filterRows(state.jrmRows, prevStart, prevEnd).filter(
            (r) => rowHasTag(r, selectedTag)
          );

          function countStatus(rows, status) {
            return rows.filter((r) => String(r[4]).toLowerCase() === status)
              .length;
          }
          const totalIntakes = filteredRows.length;
          const approvedRows = filterRows(
            state.jrmRows,
            startDate,
            endDate,
            "approved"
          ).filter(
            (r) =>
              String(r[4]).toLowerCase() === "approved" &&
              rowHasTag(r, selectedTag)
          );
          const approvedCount = approvedRows.length;
          const estimatesCount = countStatus(filteredRows, "estimates");
          const jrmCount = countStatus(filteredRows, "jrm");
          const ofsCount = countStatus(filteredRows, "ofs");

          const prevTotal = prevRows.length;
          const prevApprovedRows = filterRows(
            state.jrmRows,
            prevStart,
            prevEnd,
            "approved"
          ).filter(
            (r) =>
              String(r[4]).toLowerCase() === "approved" &&
              rowHasTag(r, selectedTag)
          );
          const prevApproved = prevApprovedRows.length;
          const prevEstimates = countStatus(prevRows, "estimates");
          const prevJrm = countStatus(prevRows, "jrm");
          const prevOfs = countStatus(prevRows, "ofs");

          function pctChange(curr, prev) {
            if (prevStart == null && prevEnd == null) {
              return { pct: 0, arrow: "", colour: "#888" };
            }
            if (prev === 0 && curr === 0)
              return { pct: 0, arrow: "", color: "#888" };
            if (prev === 0) return { pct: 100, arrow: "▲", color: "#009879" };
            const pct = ((curr - prev) / prev) * 100;
            let arrow = pct > 0 ? "▲" : pct < 0 ? "▼" : "";
            let color = pct > 0 ? "#009879" : pct < 0 ? "#d9534f" : "#888";
            return { pct: Math.abs(pct), arrow, color };
          }
          const pctTotal = pctChange(totalIntakes, prevTotal);
          const pctJrm = pctChange(jrmCount, prevJrm);
          const pctApproved = pctChange(approvedCount, prevApproved);
          const pctEstimates = pctChange(estimatesCount, prevEstimates);
          const pctOfs = pctChange(ofsCount, prevOfs);

          if (dashboardType === "metric") {
            const disciplines = [
              { key: "ba", label: "BA", color: "#009879" },
              { key: "qa", label: "QA", color: "#38c6d9" },
              { key: "aoto", label: "AO/TO", color: "#a0c4ff" },
              { key: "pmo", label: "PMO", color: "#f39c12" },
              { key: "dev", label: "Dev", color: "#4a90e2" },
            ];

            const metricOptions = [
              { value: "totalcost", label: "Total Cost" },
              { value: "cost%", label: "Cost %" },
              { value: "effort%", label: "Effort %" },
              { value: "effortdays", label: "Effort Days" },
            ];
            function getMetricIndices(discipline, metric) {
              const map = {
                "cost%": "cost %",
                "effort%": "effort %",
                totalcost: "total cost",
                effortdays: "total effort days",
              };
              const search = discipline === "aoto" ? "ao/to" : discipline;
              const metricStr = map[metric];
              return state.tableHeaders
                .map((h, idx) =>
                  h.toLowerCase().includes(search) &&
                  h.toLowerCase().includes(metricStr)
                    ? idx
                    : -1
                )
                .filter((idx) => idx !== -1);
            }
            function filterMetricsRows(rows, s, e) {
              if (!s || !e)
                return rows.filter((row) => {
                  const id = normalizeID(row[0]);

                  const jrmRow = state.jrmRows.find(
                    (jrm) => normalizeID(jrm[0]) === id
                  );
                  return rowHasTag(jrmRow || [], selectedTag);
                });
              return rows.filter((row) => {
                const id = normalizeID(row[0]);
                const approvedDate = state.jrmApprovedMapping[id];
                if (!approvedDate || approvedDate === "N/A") return false;
                const d = new Date(approvedDate);

                const jrmRow = state.jrmRows.find(
                  (jrm) => normalizeID(jrm[0]) === id
                );
                if (!rowHasTag(jrmRow || [], selectedTag)) return false;
                const eDate = e ? new Date(e) : null;
                return (
                  !isNaN(d) && d >= s && d <= eDate.setDate(eDate.getDate() + 1)
                );
              });
            }
            const filteredMetricsRows = filterMetricsRows(
              state.metricsRows,
              startDate,
              endDate
            );
            const prevMetricsRows = filterMetricsRows(
              state.metricsRows,
              prevStart,
              prevEnd
            );

            function getTotals(rows, metric) {
              const totals = {};
              disciplines.forEach((d) => {
                const idxs = getMetricIndices(d.key, metric);
                let sum = 0;
                rows.forEach((row) => {
                  idxs.forEach((idx) => {
                    let v = parseFloat(row[idx]) || 0;
                    if (!isNaN(v)) sum += v;
                  });
                });
                totals[d.key] = sum;
              });
              return totals;
            }

            const allMetrics = ["totalcost", "cost%", "effort%", "effortdays"];
            const currTotals = {};
            const prevTotals = {};
            allMetrics.forEach((metric) => {
              currTotals[metric] = getTotals(filteredMetricsRows, metric);
              prevTotals[metric] = getTotals(prevMetricsRows, metric);
            });
            const lobIdx = state.tableHeaders.findIndex(
              (h) => h.trim().toLowerCase() === "cpt-lob sub-total"
            );
            const contIdx = state.tableHeaders.findIndex(
              (h) => h.trim().toLowerCase() === "contingency"
            );
            function sumLobCont(rows) {
              let total = 0;
              rows.forEach((row) => {
                let lob = parseFloat(row[lobIdx]) || 0;
                let cont = parseFloat(row[contIdx]) || 0;
                total += lob + cont;
              });
              return total;
            }
            const lobContTotal = sumLobCont(filteredMetricsRows);
            const prevLobContTotal = sumLobCont(prevMetricsRows);
            const lobContPct = pctChange(lobContTotal, prevLobContTotal);
            function formatMetric(val, metric) {
              if (metric === "cost%") return val.toFixed(2) + "%";
              if (metric === "effort%") return val.toFixed(2) + "%";
              if (metric === "totalcost")
                return new Intl.NumberFormat("en-US", {
                  style: "currency",
                  currency: "USD",
                }).format(val);
              if (metric === "effortdays") return val.toLocaleString();
              return val;
            }

            function getAvgApprovalTime(rows) {
              let totalDays = 0,
                count = 0;
              rows.forEach((row) => {
                const id = normalizeID(row[0]);
                const jrmDate = state.jrmDateMapping[id];
                const approvedDate = state.jrmApprovedMapping[id];
                if (
                  jrmDate &&
                  approvedDate &&
                  approvedDate !== "N/A" &&
                  jrmDate !== "N/A"
                ) {
                  const jrm = new Date(jrmDate);
                  const approved = new Date(approvedDate);
                  if (!isNaN(jrm) && !isNaN(approved) && approved > jrm) {
                    totalDays += (approved - jrm) / (1000 * 60 * 60 * 24);
                    count++;
                  }
                }
              });
              return count ? totalDays / count : 0;
            }

            function getApprovedIntakeDays(rows) {
              const result = [];
              rows.forEach((row) => {
                const id = normalizeID(row[0]);
                const name = state.jrmNameMapping[id] || row[1] || row[0] || "";
                const jrmDate = state.jrmDateMapping[id];
                const approvedDate = state.jrmApprovedMapping[id];
                if (
                  jrmDate &&
                  approvedDate &&
                  approvedDate !== "N/A" &&
                  jrmDate !== "N/A"
                ) {
                  const jrm = new Date(jrmDate);
                  const approved = new Date(approvedDate);
                  if (!isNaN(jrm) && !isNaN(approved) && approved > jrm) {
                    const days = Math.round(
                      (approved - jrm) / (1000 * 60 * 60 * 24)
                    );
                    result.push({ name: name, days });
                  }
                }
              });
              return result;
            }

            const avgApprovalTime = getAvgApprovalTime(approvedRows);
            const prevAvgApprovalTime = getAvgApprovalTime(prevApprovedRows);
            const pctAvgApproval = pctChange(
              avgApprovalTime,
              prevAvgApprovalTime
            );
            const approvedIntakeDays = getApprovedIntakeDays(approvedRows);

            function getDisciplineCardHtml(d) {
              const metrics = [
                { key: "totalcost", label: "Total Cost" },
                { key: "cost%", label: "Cost %" },
                { key: "effort%", label: "Effort %" },
                { key: "effortdays", label: "Effort Days" },
              ];
              return `
                <div style="font-size:1.2em;font-weight:bold;margin-bottom:8px;color:${
                  d.color
                };">${d.label}</div>
                <table style="width:100%;font-size:1em;margin-bottom:0;">
                  <thead><tr><th style="text-align:left;">Metric</th><th style="text-align:right;">Value</th></tr></thead>
                  <tbody>
                    ${metrics
                      .map((m) => {
                        const curr = currTotals[m.key][d.key] || 0;
                        const prev = prevTotals[m.key][d.key] || 0;
                        const pct = pctChange(curr, prev);
                        return `<tr><td>${
                          m.label
                        }</td><td style="text-align:right;">${formatMetric(
                          curr,
                          m.key
                        )}</td><td style="text-align:right;color:${
                          pct.color
                        };">${pct.arrow} ${pct.pct.toFixed(1)}%</td></tr>`;
                      })
                      .join("")}
                  </tbody>
                </table>
              `;
            }

            $("dashboard-content").innerHTML = `
              <div class="container" style="max-width:1100px;margin:auto;">
                <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
                  <button
                    id="dashboardBackBtn"
                    style="background:none;border:none;font-size:2em;cursor:pointer;color:#4a90e2;"
                  >
                    &#8592;
                  </button>
                  <div>
                    <select id="dashboardDateRange" style="padding:6px 10px;font-size:1em;">
                      <option value="all"${
                        selectedRange === "all" ? " selected" : ""
                      }>All Time</option>
                      <option value="month"${
                        selectedRange === "month" ? " selected" : ""
                      }>Past 1 Month</option>
                      <option value="4months"${
                        selectedRange === "4months" ? " selected" : ""
                      }>Past 4 Months</option>
                      <option value="year"${
                        selectedRange === "year" ? " selected" : ""
                      }>Past 1 Year</option>
                      <option value="custom"${
                        selectedRange === "custom" ? " selected" : ""
                      }>Custom Range</option>
                    </select>
                  </div>
                  <!-- Tag Filter Dropdown -->
                  <div>
                    <select id="dashboardTagFilter" style="padding:6px 10px;font-size:1em;min-width:120px;">
                      <option value="">All Tags</option>
                      ${allTags
                        .map(
                          (tag) =>
                            `<option value="${tag.replace(/"/g, "&quot;")}"${
                              selectedTag === tag ? " selected" : ""
                            }>${tag}</option>`
                        )
                        .join("")}
                    </select>
                  </div>
                  <div
                    id="dashboardCustomDateFields"
                    style="display:${
                      selectedRange === "custom" ? "flex" : "none"
                    };align-items:center;gap:8px;"
                  >
                    <label>
                      Previous Start:
                      <input
                        type="date"
                        id="dashboardPrevCustomStart"
                        value="${window.dashboardPrevCustomStart || ""}"
                        style="padding:4px 6px;"
                      >
                    </label>
                    <label>
                      Previous End:
                      <input
                        type="date"
                        id="dashboardPrevCustomEnd"
                        value="${window.dashboardPrevCustomEnd || ""}"
                        style="padding:4px 6px;"
                      >
                    </label>
                    <label>
                      Current Start:
                      <input
                        type="date"
                        id="dashboardCustomStart"
                        value="${window.dashboardCustomStart || ""}"
                        style="padding:4px 6px;"
                      >
                    </label>
                    <label>
                      Current End:
                      <input
                        type="date"
                        id="dashboardCustomEnd"
                        value="${window.dashboardCustomEnd || ""}"
                        style="padding:4px 6px;"
                      >
                    </label>
                    <!-- NEW: Prev Start/End -->
                    <button
                      id="dashboardCustomApplyBtn"
                      style="padding:4px 10px;font-size:1em;background:#009879;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-top:25px;"
                    >
                      Apply
                    </button>
                  </div>
                  <button
                    id="dashboardExportExcelBtn"
                    style="margin-left:auto;padding:8px 16px;font-size:1em;background:#009879;color:#fff;border:none;border-radius:5px;cursor:pointer;"
                  >
                    Export to Excel
                  </button>
                </div>

                <h2 style="margin-bottom:24px;text-align:center;display:flex;align-items:center;justify-content:center;gap:12px;">
                  Metric Dashboard
                </h2>

                <!-- NEW: Combined row for two cards on left, pie on right -->
                <div style="display:flex;gap:32px;align-items:flex-start;margin-bottom:32px;flex-wrap:wrap;">

                  <!-- Left column: two stacked cards -->
                  <div style="display:flex;flex-direction:column;gap:32px;flex:1;min-width:400px;max-width:480px;">

                    <!-- Grand Total Card -->
                    <div style="background:#fff;border-radius:12px;box-shadow:0 2px 8px #e5e9f2;padding:16px 18px;text-align:center;display:flex;flex-direction:column;align-items:center;font-size:0.9em;">
                      <div style="font-size:1.2em;font-weight:bold;margin-bottom:8px;color:#555;">Grand Total (LOB Sub-Total + Contingency)</div>
                      <div style="font-size:2.2em;font-weight:bold;color:#4a90e2;">
                        ${new Intl.NumberFormat("en-US", {
                          style: "currency",
                          currency: "USD",
                        }).format(lobContTotal)}
                        <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                          lobContPct.color
                        };">
                          ${lobContPct.arrow} ${lobContPct.pct.toFixed(1)}%
                        </span>
                      </div>
                      <div style="font-size:1em;color:#888;margin-top:4px;">Compared to previous period</div>
                    </div>

                    <!-- Average Approval Time Card -->
                    <div id="avgApprovalCard" style="background:#fff;border-radius:12px;box-shadow:0 2px 8px #e5e9f2;padding:16px 18px;text-align:center;display:flex;flex-direction:column;align-items:center;position:relative;font-size:0.9em;">
                      <div id="avgApprovalFront">
                        <div style="font-size:1.2em;font-weight:bold;margin-bottom:8px;color:#555;">Average Approval Time For Approved Intakes</div>
                        <div style="font-size:2.2em;font-weight:bold;color:#009879;">
                          ${avgApprovalTime.toFixed(1)} days
                          <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                            pctAvgApproval.color
                          };">
                            ${
                              pctAvgApproval.arrow
                            } ${pctAvgApproval.pct.toFixed(1)}%
                          </span>
                        </div>
                        <div style="font-size:1em;color:#888;margin-top:4px;">Compared to previous period</div>
                        <button id="showIntakeBtn" style="margin-top:12px;padding:4px 10px;font-size:1em;background:#4a90e2;color:#fff;border:none;border-radius:5px;cursor:pointer;">Show intake</button>
                      </div>
                      <div id="avgApprovalBack" style="display:none;">
                        <div style="font-size:1.1em;font-weight:bold;margin-bottom:8px;color:#555;">Approval Days by Intake</div>
                        <div style="max-height:180px;overflow-y:auto;width:100%;text-align:left;">
                          ${
                            approvedIntakeDays.length
                              ? approvedIntakeDays
                                  .map(
                                    (x) =>
                                      `<div style="margin-bottom:4px;"><b>${x.name}</b> - ${x.days} days</div>`
                                  )
                                  .join("")
                              : "<div>No approved intakes in this period.</div>"
                          }
                        </div>
                        <button id="backToAvgBtn" style="margin-top:12px;padding:4px 10px;font-size:1em;background:#009879;color:#fff;border:none;border-radius:5px;cursor:pointer;">Back</button>
                      </div>
                    </div>

                  </div>

                  <!-- Right column: Pie chart card -->
                  <div id="pieChartCard" style="background:#fff;border-radius:12px;box-shadow:0 2px 8px #e5e9f2;padding:32px 36px;flex:2;min-width:420px;max-width:820px;text-align:center;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <h3 style="margin:0;font-size:1.2em;color:#555;">Top 5 Intakes by</h3>
                      <select id="dashboardMetricPie" style="padding:4px 6px;"></select>
                    </div>
                    <div id="dashboardPieChart" style="width:100%;height:280px;"></div>
                  </div>
                </div>

                <div style="display:flex;flex-wrap:wrap;gap:32px;justify-content:center;">
                  ${disciplines
                    .map(
                      (d) => `
                    <div
                      style="flex:1;min-width:320px;max-width:420px;background:#fff;border-radius:12px;box-shadow:0 2px 8px #e5e9f2;padding:28px 24px;margin-bottom:12px;display:flex;flex-direction:column;align-items:center;"
                    >
                      ${getDisciplineCardHtml(d)}
                    </div>`
                    )
                    .join("")}
                </div>
              </div>
            `;
            setTimeout(() => {
              document.getElementById("dashboardBackBtn").onclick =
                function () {
                  renderDashboard(selectedRange, "executive");
                  showSection("dashboard-content");
                };
              document.getElementById("dashboardDateRange").onchange =
                function () {
                  renderDashboard(this.value, "metric");
                  showSection("dashboard-content");
                };
              document.getElementById("dashboardExportExcelBtn").onclick =
                function () {
                  exportAll("excel");
                };

              const showBtn = document.getElementById("showIntakeBtn");
              const backBtn = document.getElementById("backToAvgBtn");
              const front = document.getElementById("avgApprovalFront");
              const back = document.getElementById("avgApprovalBack");
              if (showBtn && back && front) {
                showBtn.onclick = function () {
                  front.style.display = "none";
                  back.style.display = "block";
                };
              }
              if (backBtn && back && front) {
                backBtn.onclick = function () {
                  back.style.display = "none";
                  front.style.display = "block";
                };
              }
              const tagSel = document.getElementById("dashboardTagFilter");
              if (tagSel) {
                tagSel.onchange = function () {
                  window.dashboardSelectedTag = this.value;
                  renderDashboard(selectedRange, dashboardType);
                  showSection("dashboard-content");
                };
              }
              const applyBtn = document.getElementById(
                "dashboardCustomApplyBtn"
              );
              if (applyBtn) {
                applyBtn.onclick = function () {
                  window.dashboardCustomStart = document.getElementById(
                    "dashboardCustomStart"
                  ).value;
                  window.dashboardCustomEnd =
                    document.getElementById("dashboardCustomEnd").value;
                  window.dashboardPrevCustomStart = document.getElementById(
                    "dashboardPrevCustomStart"
                  ).value;
                  window.dashboardPrevCustomEnd = document.getElementById(
                    "dashboardPrevCustomEnd"
                  ).value;
                  renderDashboard("custom", "metric");
                  showSection("dashboard-content");
                };
              }
              const pieSel = document.getElementById("dashboardMetricPie");
              state.metricOptions.forEach((opt) => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                pieSel.appendChild(o);
              });

              pieSel.onchange = () =>
                updatePieChart(pieSel.value, filteredMetricsRows);
              updatePieChart(state.metricOptions[0], filteredMetricsRows);

              function updatePieChart(metric, rows) {
                const col = state.metricMapping[metric];
                const data = rows
                  .map((r) => ({
                    name: "ENT-" + normalizeID(r[0]),
                    y: parseFloat(r[col]) || 0,
                  }))
                  .sort((a, b) => b.y - a.y)
                  .slice(0, 5);
                Highcharts.chart("dashboardPieChart", {
                  chart: { type: "pie" },
                  title: { text: "" },
                  series: [{ name: "Value", data }],
                  plotOptions: { pie: { size: "70%" } },
                  tooltip: { pointFormat: "<b>{point.name}</b>: {point.y}" },
                });
              }
            }, 0);
            return;
          }

          $("dashboard-content").innerHTML = `
            <div class="container" style="max-width:1100px;margin:auto;">
              <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
                <div>
                  <select id="dashboardDateRange" style="padding:6px 10px;font-size:1em;">
                    <option value="all"${
                      selectedRange === "all" ? " selected" : ""
                    }>All Time</option>
                    <option value="month"${
                      selectedRange === "month" ? " selected" : ""
                    }>Past 1 Month</option>
                    <option value="4months"${
                      selectedRange === "4months" ? " selected" : ""
                    }>Past 4 Months</option>
                    <option value="year"${
                      selectedRange === "year" ? " selected" : ""
                    }>Past 1 Year</option>
                    <option value="custom"${
                      selectedRange === "custom" ? " selected" : ""
                    }>Custom Range</option>
                  </select>
                </div>
                <!-- Tag Filter Dropdown -->
                <div>
                  <select id="dashboardTagFilter" style="padding:6px 10px;font-size:1em;min-width:120px;">
                    <option value="">All Tags</option>
                    ${allTags
                      .map(
                        (tag) =>
                          `<option value="${tag.replace(/"/g, "&quot;")}"${
                            selectedTag === tag ? " selected" : ""
                          }>${tag}</option>`
                      )
                      .join("")}
                  </select>
                </div>
                <div id="dashboardCustomDateFields" style="display:${
                  selectedRange === "custom" ? "flex" : "none"
                };align-items:center;gap:8px;">
                  <label>Previous Start: <input type="date" id="dashboardPrevCustomStart" value="${
                    window.dashboardPrevCustomStart || ""
                  }" style="padding:4px 6px;"></label>
                  <label>Previous End: <input type="date" id="dashboardPrevCustomEnd" value="${
                    window.dashboardPrevCustomEnd || ""
                  }" style="padding:4px 6px;"></label>
                  <label>Current Start: <input type="date" id="dashboardCustomStart" value="${
                    window.dashboardCustomStart || ""
                  }" style="padding:4px 6px;"></label>
                  <label>Current End: <input type="date" id="dashboardCustomEnd" value="${
                    window.dashboardCustomEnd || ""
                  }" style="padding:4px 6px;"></label>
                  <!-- NEW: Prev Start/End -->
                  <button id="dashboardCustomApplyBtn" style="padding:4px 10px;font-size:1em;background:#009879;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-top:25px;">Apply</button>
                </div>
                <button id="dashboardExportExcelBtn" style="margin-left:auto;padding:8px 16px;font-size:1em;background:#009879;color:#fff;border:none;border-radius:5px;cursor:pointer;">Export to Excel</button>
              </div>
              <h2 style="margin-bottom:24px;text-align:center;display:flex;align-items:center;justify-content:center;gap:12px;">
                Executive Dashboard
                <button id="dashboardNextBtn" style="background:none;border:none;font-size:1.2em;cursor:pointer;color:#4a90e2;margin-left:8px;">&#8594;</button>
              </h2>
              <div style="display:flex;gap:24px;justify-content:center;margin-bottom:32px;">
                <div style="flex:1;min-width:160px;background:#f7fafb;border-radius:10px;padding:24px 12px;text-align:center;box-shadow:0 2px 8px #e5e9f2;">
                  <div style="font-size:2.2em;font-weight:bold;color:#4a90e2;">
                    ${totalIntakes}
                    <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                      pctTotal.color
                    };">
                      ${pctTotal.arrow} ${pctTotal.pct.toFixed(1)}%
                    </span>
                  </div>
                  <div style="font-size:1.1em;color:#555;">Total Intakes</div>
                </div>
                <div style="flex:1;min-width:160px;background:#f7fafb;border-radius:10px;padding:24px 12px;text-align:center;box-shadow:0 2px 8px #e5e9f2;">
                  <div style="font-size:2.2em;font-weight:bold;color:#009879;">
                    ${jrmCount}
                    <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                      pctJrm.color
                    };">
                      ${pctJrm.arrow} ${pctJrm.pct.toFixed(1)}%
                    </span>
                  </div>
                  <div style="font-size:1.1em;color:#555;">JRM</div>
                </div>
                <div style="flex:1;min-width:160px;background:#f7fafb;border-radius:10px;padding:24px 12px;text-align:center;box-shadow:0 2px 8px #e5e9f2;">
                  <div style="font-size:2.2em;font-weight:bold;color:#38c6d9;">
                    ${approvedCount}
                    <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                      pctApproved.color
                    };">
                      ${pctApproved.arrow} ${pctApproved.pct.toFixed(1)}%
                    </span>
                  </div>
                  <div style="font-size:1.1em;color:#555;">Approved</div>
                </div>
                <div style="flex:1;min-width:160px;background:#f7fafb;border-radius:10px;padding:24px 12px;text-align:center;box-shadow:0 2px 8px #e5e9f2;">
                  <div style="font-size:2.2em;font-weight:bold;color:#f39c12;">
                    ${estimatesCount}
                    <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                      pctEstimates.color
                    };">
                      ${pctEstimates.arrow} ${pctEstimates.pct.toFixed(1)}%
                    </span>
                  </div>
                  <div style="font-size:1.1em;color:#555;">Estimates</div>
                </div>
                <div style="flex:1;min-width:160px;background:#f7fafb;border-radius:10px;padding:24px 12px;text-align:center;box-shadow:0 2px 8px #e5e9f2;">
                  <div style="font-size:2.2em;font-weight:bold;color:#d9534f;">
                    ${ofsCount}
                    <span style="font-size:0.6em;vertical-align:middle;margin-left:6px;color:${
                      pctOfs.color
                    };">
                      ${pctOfs.arrow} ${pctOfs.pct.toFixed(1)}%
                    </span>
                  </div>
                  <div style="font-size:1.1em;color:#555;">Out of Scope</div>
                </div>
              </div>
              <div style="display:flex;gap:32px;flex-wrap:wrap;justify-content:center;">
                <div style="flex:1;min-width:240px;max-width:380px;background:#fff;border-radius:10px;box-shadow:0 2px 8px #e5e9f2;padding:18px;">
                  <h3 style="margin-top:0;">Current vs Previous Period</h3>
                  <div id="dashboard-period-bar" style="height:260px;"></div>
                </div>
                <div style="flex:1;min-width:440px;max-width:680px;background:#fff;border-radius:10px;box-shadow:0 2px 8px #e5e9f2;padding:18px;">
                  <h3 style="margin-top:0;">Monthly Intakes Trend</h3>
                  <div id="dashboard-monthly-bar" style="height:260px;"></div>
                </div>
              </div>
            </div>
          `;

          Highcharts.chart("dashboard-period-bar", {
            chart: { type: "column" },
            title: { text: "" },
            xAxis: { categories: ["Total Intakes"] },
            yAxis: { min: 0, title: { text: "Intakes" } },
            series: [
              {
                name: "Current Period",
                data: [totalIntakes],
                color: "#4a90e2",
              },
              {
                name: "Previous Period",
                data: [prevTotal],
                color: "#b0b0b0",
              },
            ],
            plotOptions: {
              column: { grouping: true, pointPadding: 0.2, borderWidth: 0 },
            },
          });

          function getMonthKey(d) {
            return (
              d.getFullYear() +
              "-" +
              (d.getMonth() + 1).toString().padStart(2, "0")
            );
          }

          const monthMap = {};
          filteredRows.forEach((row) => {
            let d = row[6];
            if (d instanceof Date && !isNaN(d)) {
              const key = getMonthKey(d);
              monthMap[key] = (monthMap[key] || 0) + 1;
            }
          });
          const allMonths = Object.keys(monthMap).sort();
          const currCounts = allMonths.map((m) => monthMap[m] || 0);
          Highcharts.chart("dashboard-monthly-bar", {
            chart: { type: "column" },
            title: { text: "" },
            xAxis: { categories: allMonths, title: { text: "Month" } },
            yAxis: { min: 0, title: { text: "Intakes" } },
            series: [
              {
                name: "Monthly Intakes",
                data: currCounts,
                color: "#4a90e2",
              },
            ],
            plotOptions: {
              column: { grouping: true, pointPadding: 0.2, borderWidth: 0 },
            },
          });

          setTimeout(() => {
            const sel = document.getElementById("dashboardDateRange");
            const customFields = document.getElementById(
              "dashboardCustomDateFields"
            );
            if (sel) {
              sel.onchange = function () {
                if (this.value === "custom") {
                  customFields.style.display = "flex";
                } else {
                  customFields.style.display = "none";
                  window.dashboardCustomStart = "";
                  window.dashboardCustomEnd = "";
                  window.dashboardPrevCustomStart = "";
                  window.dashboardPrevCustomEnd = "";
                  renderDashboard(this.value, "executive");
                  showSection("dashboard-content");
                }
              };
            }
            const applyBtn = document.getElementById("dashboardCustomApplyBtn");
            if (applyBtn) {
              applyBtn.onclick = function () {
                const start = document.getElementById(
                  "dashboardCustomStart"
                ).value;
                const end = document.getElementById("dashboardCustomEnd").value;

                const prevStart = document.getElementById(
                  "dashboardPrevCustomStart"
                ).value;
                const prevEnd = document.getElementById(
                  "dashboardPrevCustomEnd"
                ).value;
                window.dashboardCustomStart = start;
                window.dashboardCustomEnd = end;
                window.dashboardPrevCustomStart = prevStart;
                window.dashboardPrevCustomEnd = prevEnd;
                renderDashboard("custom", "executive");
                showSection("dashboard-content");
              };
            }
            const nextBtn = document.getElementById("dashboardNextBtn");
            if (nextBtn) {
              nextBtn.onclick = function () {
                renderDashboard(selectedRange, "metric");
                showSection("dashboard-content");
              };
            }
            const exportBtn = document.getElementById(
              "dashboardExportExcelBtn"
            );
            if (exportBtn) {
              exportBtn.onclick = function () {
                exportAll("excel");
              };
            }
            const tagSel = document.getElementById("dashboardTagFilter");
            if (tagSel) {
              tagSel.onchange = function () {
                window.dashboardSelectedTag = this.value;
                renderDashboard(selectedRange, "executive");
                showSection("dashboard-content");
              };
            }
          }, 0);
        }

        const showSection = (showId) => {
          [
            "dashboard-content",
            "total-content",
            "jrm-content",
            "intake-charts",
          ].forEach((id) => $(id).classList.toggle("hidden", id !== showId));
        };

        const init = () => {
          $("totalBtn").addEventListener("click", () =>
            showSection("total-content")
          );
          $("jrmBtn").addEventListener("click", () =>
            showSection("jrm-content")
          );
          $("definitionBtn").addEventListener("click", () =>
            window.open(
              "https://cibc-my.sharepoint.com/:p:/p/peter_crescenzi/EfCWJ1Wz92JNvCgEewJyQv4BJVVJKxSRmWz6IwjROaDNNA?e=CND6ej",
              "_blank"
            )
          );
          $("dashboardBtn").addEventListener("click", () => {
            renderDashboard();
            showSection("dashboard-content");
          });
          $("saveFileBtn").addEventListener("click", saveFile);
          startLoadingBar();
          fetchData();
          console.log(state);
          showSection("jrm-content");
          $("loginBtn").addEventListener("click", () => {
            if (
              $("loginPassword").value ===
              transformPassword("abcdef", "decrypt")
            ) {
              isLoggedIn = true;
              $("loginContainer").style.display = "none";
              $$(".requires-login").forEach((el) =>
                el.classList.remove("requires-login")
              );
              initCardContextMenu();
              updateDisciplineTables();
            } else alert("Incorrect password");
          });
        };

        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>
